<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Swan Security ‚Äì Job Management (v1.8)</title>

  <!-- FullCalendar (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --panel2:#111;
      --line:#2f2f2f;
      --line2:#444;
      --text:#fff;
      --muted:rgba(255,255,255,.72);
      --ok:#7CFF8E;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --accent:#9fd3ff;
      --active:#ff7a18; /* Workever-like orange highlight */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r: 14px;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .app{ display:grid; grid-template-columns: 300px 1fr; min-height:100vh; }

    .sidebar{
      border-right:1px solid var(--line);
      background:linear-gradient(180deg, #0a0f14, #070a0d);
      padding:16px;
      position:sticky; top:0; height:100vh; overflow:auto;
    }
    .brand{
      display:flex; gap:10px; align-items:center; padding:10px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.07); margin-bottom:14px;
    }
    .logo{
      width:36px; height:36px; border-radius:10px;
      background:linear-gradient(135deg,#1a1a1a,#0c0c0c);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; color:var(--muted);
    }
    .brand h1{ font-size:14px; margin:0; line-height:1.2; }
    .brand .sub{ color:var(--muted); font-size:12px; margin-top:2px; }

    .nav-group{ margin-top:10px; }
    .nav-heading{
      margin:14px 10px 6px;
      font-size:11px;
      color:rgba(255,255,255,.50);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .nav{
      display:flex; flex-direction:column; gap:6px; margin-top:6px;
    }

    .nav button{
      width:100%;
      text-align:left;
      background:transparent;
      color:rgba(255,255,255,.88);
      border:1px solid transparent;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .nav button:hover{ background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.06); }

    .nav-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .nav-ico{
      width:22px; height:22px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:center;
      font-size:12px;
      color:rgba(255,255,255,.70);
      flex:0 0 auto;
    }
    .nav-label{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size:14px;
    }

    .nav button.active{
      background:rgba(255,122,24,.14);
      border-color:rgba(255,122,24,.35);
    }
    .nav button.active .nav-ico{
      border-color: rgba(255,122,24,.55);
      background: rgba(255,122,24,.18);
      color: var(--active);
    }
    .nav button.active .nav-label{ color: #fff; }

    .pill{
      font-size:11px; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18); color:rgba(255,255,255,.70);
      flex:0 0 auto;
    }

    .divider{
      height:1px;
      background:rgba(255,255,255,.08);
      margin:14px 10px;
    }

    .content{ padding:18px 18px 32px; overflow:auto; }

    .topbar{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:14px;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:var(--panel);
      box-shadow: var(--shadow);
      position:sticky; top:12px;
      z-index:5;
    }

    .search{
      flex:1;
      min-width:240px;
      display:flex; gap:8px; align-items:center;
      background:var(--panel2);
      border:1px solid var(--line2);
      border-radius:12px;
      padding:8px 10px;
    }
    .search input{
      width:100%; background:transparent; color:var(--text);
      border:none; outline:none; font-size:14px;
    }

    .btn{
      background:#222; color:var(--text);
      border:1px solid #555;
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{ background:#2b2b2b; }
    .btn.primary{ border-color: rgba(159,211,255,.45); background: rgba(159,211,255,.10); }
    .btn.primary:hover{ background: rgba(159,211,255,.14); }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:14px; }
    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .grid{ grid-template-columns:1fr; }
      .topbar{ position:relative; top:auto; }
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 8px; font-size:16px; }
    .muted{ color:var(--muted); }
    .small{ font-size:12px; color:var(--muted); }

    .kpis{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:10px; margin-top:12px; }
    @media (max-width: 1000px){ .kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .kpi{
      background:var(--panel2);
      border:1px solid var(--line2);
      border-radius:14px;
      padding:10px;
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-size:18px; font-weight:700; margin-top:4px; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
    }
    th,td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      vertical-align:middle;
    }
    th{ background:var(--panel2); color:var(--muted); font-weight:600; font-size:12px; letter-spacing:.2px; }
    tr:hover td{ background: rgba(255,255,255,.03); }

    .status{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--line2); background:var(--panel2);
      color:var(--muted); white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background:var(--muted); }
    .s-booked .dot{ background: var(--warn); }
    .s-progress .dot{ background: var(--accent); }
    .s-completed .dot{ background: var(--ok); }
    .s-invoiced .dot{ background: #c3a6ff; }
    .s-paid .dot{ background: var(--ok); }
    .s-overdue .dot{ background: var(--bad); }

    .split{ display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:14px; }
    @media (max-width: 1100px){ .split{ grid-template-columns:1fr; } }

    .form{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .field label{ display:block; color:var(--muted); font-size:12px; margin-bottom:6px; }
    .field input, .field select, .field textarea{
      width:100%; padding:9px 10px; border-radius:12px;
      border:1px solid var(--line2);
      background:var(--panel2); color:var(--text); outline:none;
    }
    .field textarea{ min-height:90px; resize:vertical; grid-column:1/-1; }
    .field.span2{ grid-column: 1/-1; }

    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.78);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:50;
    }
    .modal{
      width:100%; max-width:860px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:14px;
      max-height: 90vh;
      overflow:auto;
    }
    .modal header{
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid var(--line);
      padding-bottom:10px; margin-bottom:10px;
    }
    .modal header h3{ margin:0; font-size:15px; }
    .modal .x{
      border:1px solid var(--line2);
      background:transparent;
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
    }
    .modal .x:hover{ background: rgba(255,255,255,.04); }

    .right{ text-align:right; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* FullCalendar styling to fit dark UI */
    .fc {
      --fc-page-bg-color: transparent;
      --fc-neutral-bg-color: rgba(255,255,255,.04);
      --fc-border-color: rgba(255,255,255,.08);
      --fc-today-bg-color: rgba(159,211,255,.08);
      --fc-list-event-hover-bg-color: rgba(255,255,255,.06);
      color: var(--text);
    }
    .fc .fc-toolbar-title{ color: var(--text); }
    .fc .fc-button {
      background: #222 !important;
      border: 1px solid #555 !important;
      color: var(--text) !important;
      border-radius: 10px !important;
      padding: 8px 10px !important;
    }
    .fc .fc-button:hover{ background:#2b2b2b !important; }
    .fc .fc-button-primary:not(:disabled).fc-button-active{
      background: rgba(255,122,24,.18) !important;
      border-color: rgba(255,122,24,.42) !important;
    }
    .fc-daygrid-event { cursor: grab; }
    .fc-daygrid-event:active { cursor: grabbing; }
  
/* ===== Job Parts Picker (v1.8) ===== */
.jp-wrap{ margin-top:14px; padding-top:10px; border-top:1px solid #222; }
.jp-help{ color:#aaa; font-size:12px; margin:6px 0 10px; }
.jp-searchRow{ display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; }
.jp-searchRow .field{ flex:1; min-width:240px; }
.jp-suggestions{
  background:#0f0f0f;
  border:1px solid #333;
  border-radius:10px;
  margin-top:8px;
  max-height:220px;
  overflow:auto;
}
.jp-suggestion{
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid #222;
  display:grid;
  grid-template-columns: 90px 1fr auto;
  gap:10px;
  align-items:start;
}
.jp-suggestion:last-child{ border-bottom:none; }
.jp-suggestion:hover{ background:#171717; }
.jp-code{ font-weight:700; color:#d7d7d7; }
.jp-name{ color:#fff; }
.jp-meta{ color:#aaa; font-size:12px; white-space:nowrap; }
.jp-picked{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px; }
.jp-picked .pill{ border:1px solid #333; border-radius:999px; padding:6px 10px; color:#ddd; font-size:12px; }
.jp-table th{ white-space:nowrap; }

</style>
</head>

<body>
<div class="app">

  <aside class="sidebar">
    <div class="brand">
      <div class="logo">SS</div>
      <div>
        <h1>Swan Security</h1>
        <div class="sub">Job Manager (v1.8)</div>
      </div>
    </div>

    <div class="nav-group">
      <div class="nav-heading">Main</div>
      <div class="nav">
        <button id="navDashboard" class="active" onclick="go('dashboard')">
          <span class="nav-left"><span class="nav-ico">‚ñ¶</span><span class="nav-label">Dashboard</span></span>
          <span class="pill" id="pillDash">Live</span>
        </button>
      </div>

      <div class="nav-heading">Jobs</div>
      <div class="nav">
        <button id="navJobs" onclick="go('jobs')">
          <span class="nav-left"><span class="nav-ico">‚éò</span><span class="nav-label">Jobs</span></span>
          <span class="pill" id="pillJobs">0</span>
        </button>
        <button id="navQuotes" onclick="go('quotes')">
          <span class="nav-left"><span class="nav-ico">‚â°</span><span class="nav-label">Quotes</span></span>
          <span class="pill">Soon</span>
        </button>
        <button id="navInvoices" onclick="go('invoices')">
          <span class="nav-left"><span class="nav-ico">üßæ</span><span class="nav-label">Invoices</span></span>
          <span class="pill" id="pillInvoices">0</span>
        </button>
        <button id="navCalendar" onclick="go('calendar')">
          <span class="nav-left"><span class="nav-ico">üìÖ</span><span class="nav-label">Scheduler</span></span>
          <span class="pill" id="pillCal">Drag</span>
        </button>
      </div>

      <div class="nav-heading">Contacts</div>
      <div class="nav">
        <button id="navClients" onclick="go('clients')">
          <span class="nav-left"><span class="nav-ico">üë•</span><span class="nav-label">Contacts</span></span>
          <span class="pill" id="pillClients">0</span>
        </button>
        <button id="navSites" onclick="go('sites')">
          <span class="nav-left"><span class="nav-ico">‚åÇ</span><span class="nav-label">Sites</span></span>
          <span class="pill" id="pillSites">0</span>
        </button>
      </div>

      <div class="nav-heading">Operations</div>
      <div class="nav">
        <button id="navPO" onclick="go('purchaseOrders')">
          <span class="nav-left"><span class="nav-ico">üõí</span><span class="nav-label">Purchase orders</span></span>
          <span class="pill">Soon</span>
        </button>
        <button id="navTimesheets" onclick="go('timesheets')">
          <span class="nav-left"><span class="nav-ico">‚è±</span><span class="nav-label">Timesheets &amp; Expenses</span></span>
          <span class="pill">Soon</span>
        </button>
        <button id="navReminders" onclick="go('reminders')">
          <span class="nav-left"><span class="nav-ico">üîî</span><span class="nav-label">Reminders</span></span>
          <span class="pill">2</span>
        </button>
        <button id="navAssets" onclick="go('assets')">
          <span class="nav-left"><span class="nav-ico">üß∞</span><span class="nav-label">Assets</span></span>
          <span class="pill">Soon</span>
        </button>
        <button id="navContracts" onclick="go('contracts')">
          <span class="nav-left"><span class="nav-ico">üìÑ</span><span class="nav-label">Contracts</span></span>
          <span class="pill">Soon</span>
        </button>
        <button id="navDocuments" onclick="go('documents')">
          <span class="nav-left"><span class="nav-ico">üóÇ</span><span class="nav-label">Documents</span></span>
          <span class="pill">Soon</span>
        </button>
      </div>

      <div class="divider"></div>

      <div class="nav-heading">Settings</div>
      <div class="nav">
        <button id="navSettings" onclick="go('settings')">
          <span class="nav-left"><span class="nav-ico">‚öô</span><span class="nav-label">Settings</span></span>
          <span class="pill">VAT 20%</span>
        </button>
      </div>
    </div>

    <div style="margin-top:16px; border-top:1px solid rgba(255,255,255,.08); padding-top:12px;">
      <div class="muted" style="font-size:12px;">Engineer (demo)</div>
      <select id="engineerSelect" onchange="persist()" style="margin-top:8px; width:100%; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:var(--text);">
        <option>Lewis Winters</option>
        <option>Luke Scott</option>
      </select>

      <div class="toolbar" style="margin-top:10px;">
        <button class="btn" onclick="resetDemo()">Reset demo data</button>
        <button class="btn" onclick="exportJson()">Export JSON</button>
        <button class="btn" onclick="importJsonPick()">Import JSON</button>
        <input id="importJsonFile" type="file" accept="application/json" style="display:none" />
      </div>

      <div class="muted" style="font-size:11px; margin-top:8px; line-height:1.35;">
        Calendar uses CDN. When you go live on Synology, we can bundle everything locally.
      </div>
    </div>
  </aside>

  <main class="content">
    <div class="topbar">
      <div class="search">
        <span class="muted">üîé</span>
        <input id="globalSearch" placeholder="Search client / site / job / invoice‚Ä¶" oninput="render()" />
      </div>

      <button class="btn primary" onclick="openModal('addClient')">+ New Client</button>
      <button class="btn" onclick="openModal('addSite')">+ New Site</button>
      <button class="btn" onclick="openModal('addJob')">+ New Job</button>
      <button class="btn" onclick="openModal('addInvoice')">+ New Invoice</button>
    </div>

    <div id="view"></div>
  </main>
</div>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <header>
      <h3 id="modalTitle">Modal</h3>
      <button class="x" onclick="closeModal()">‚úï</button>
    </header>
    <div id="modalBody"></div>
  </div>
</div>

<script>
const STORAGE_KEY = "SwanJobManagerPrototype_v13_sidebarheadings";
// ===== Quotes integration (Swan v17) =====
// Embeds Swan v17 inside a sandboxed iframe so it cannot break the Job Manager UI.
const SWAN_QUOTE_HTML_V17 = `<!-- Swan Security Quote Builder - VERSION 17 (v16 + Inventory Edit/Delete + Audit Trail + Processed stock depletion) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Swan Security ‚Äì Quote Builder (v17)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    --bg:#000;
    --panel:#0b0b0b;
    --panel2:#111;
    --border:#444;
    --border2:#555;
    --text:#fff;
    --muted:rgba(255,255,255,0.75);
    --danger:#ff6b6b;
    --warn:#ffcc66;
    --ok:#7CFF8E;
  }

  body { background:var(--bg); color:var(--text); font-family: Arial, sans-serif; padding:20px; }

  h2,h3 { margin-top:18px; }
  h2 { display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; }
  .ver-badge{
    font-size:12px; padding:3px 8px; border:1px solid var(--border); background:var(--panel2); color:var(--muted);
  }

  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid var(--border); padding:6px; text-align:center; vertical-align:middle; }
  th { background:var(--panel2); position:sticky; top:0; z-index:5; }

  input, select {
    background:var(--panel2); color:var(--text);
    border:1px solid var(--border2); padding:4px; width:100%; box-sizing:border-box;
  }

  .right { text-align:right; }
  button {
    background:#222; color:var(--text); border:1px solid var(--border2);
    padding:8px 14px; cursor:pointer; margin:5px 0;
  }
  button:hover { background:#333; }

  .section { margin-top:24px; }

  .top-row{
    display:flex; gap:10px; margin-bottom:10px; align-items:center; flex-wrap:wrap;
  }
  .top-row input{ width:150px; }

  .dash {
    display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    border:1px solid var(--border); background:var(--panel2);
    padding:10px; margin:12px 0 14px;
  }
  .dash-item{ display:flex; gap:6px; align-items:center; }
  .dash-item label{ color:var(--muted); font-size:12px; }
  .dash-item strong{ font-size:14px; }
  .dash-spacer{ flex:1; }

  .autocomplete-wrap{ position:relative; }
  .autocomplete-suggestions{
  position: static;
  display:block;
  background:#0f0f0f;
  border:1px solid #444;
  max-height:260px;
  overflow-y:auto;
  margin-top:8px;
  border-radius:8px;
  padding:4px;
}
  .autocomplete-suggestion{
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid #222;
  text-align:left;
  line-height:1.2;
  display:flex;
  gap:12px;
  align-items:flex-start;
  font-size:14px;
}
.autocomplete-suggestion:last-child{border-bottom:none;}
.autocomplete-suggestion:hover{background:#1b1b1b;}
.autocomplete-suggestion .code{
  font-weight:800;
  min-width:88px;
  color:#e6e6e6;
}
.autocomplete-suggestion .name{
  flex:1;
  color:#ffffff;
}
.autocomplete-suggestion .meta{
  color:#bdbdbd;
  white-space:nowrap;
  font-size:13px;
}
  .autocomplete-suggestion:hover { background:#333; }

  .login-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.92);
    display: none; align-items: center; justify-content: center;
    z-index: 9999; padding: 20px; pointer-events:auto;
  }
  .login-card {
    width: 100%; max-width: 420px;
    border: 1px solid var(--border);
    background: var(--panel);
    padding: 18px;
    pointer-events:auto;
  }
  .login-card *{ pointer-events:auto; }
  .login-title { font-size: 18px; margin: 0 0 12px 0; text-align:center; }
  .login-grid { display:grid; gap:10px; }
  .login-grid label { text-align:left; font-size:13px; color:var(--muted); }
  .login-actions { display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:10px; }
  .login-error { color:var(--danger); font-size:13px; min-height:18px; }
  .app-hidden { display:none; }

  .user-pill{
    display:inline-flex; gap:8px; align-items:center;
    border:1px solid var(--border); background:var(--panel2);
    padding:6px 10px; margin-left:auto; white-space:nowrap;
  }
  .user-pill small { color:var(--muted); }

  .saved-quotes { min-width: 260px; width: 260px; }
  .quote-search { width:200px !important; }

  tr.stock-low td { border-color: rgba(255,204,102,0.35); }
  tr.stock-low { background: rgba(255,204,102,0.08); }
  tr.stock-negative td { border-color: rgba(255,107,107,0.35); }
  tr.stock-negative { background: rgba(255,107,107,0.10); }

  .mini-btn{
    padding:6px 8px;
    font-size:12px;
    margin:0;
    line-height:1;
  }
  .pill{
    display:inline-flex;
    padding:3px 8px;
    font-size:12px;
    border:1px solid var(--border);
    background:var(--panel2);
    color:var(--muted);
    gap:6px;
    align-items:center;
    justify-content:center;
    white-space:nowrap;
  }
  .pill.ok{ border-color: rgba(124,255,142,0.35); color: var(--ok); }
  .pill.warn{ border-color: rgba(255,204,102,0.35); color: var(--warn); }
  .pill.bad{ border-color: rgba(255,107,107,0.35); color: var(--danger); }

  .toggle-wrap{
    display:flex; gap:6px; align-items:center; justify-content:center;
  }
  .toggle-wrap input[type="checkbox"]{
    width:auto; transform: scale(1.05);
  }

  .markup-wrap{
    display:flex;
    flex-direction:column;
    gap:4px;
    align-items:stretch;
  }
  .markup-note{
    font-size:11px;
    color: var(--muted);
    text-align:left;
    min-height:14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .markup-note.preset{ color: var(--ok); }
  .markup-note.modified{ color: var(--warn); }
  .markup-preset{
    border-color: rgba(124,255,142,0.55) !important;
    box-shadow: 0 0 0 1px rgba(124,255,142,0.18) inset;
  }

  details.inventory-panel{
    border:1px solid var(--border);
    background:var(--panel2);
    padding:10px;
    margin-top:16px;
  }
  details.inventory-panel summary{
    cursor:pointer;
    font-weight:700;
    user-select:none;
  }
  .inv-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-top:10px;
  }
  .inv-actions input{ width:260px; }
  .inv-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    margin-top:12px;
  }
  .inv-box{
    border:1px solid var(--border);
    background:var(--panel);
    padding:10px;
  }
  .inv-box h4{ margin:0 0 10px 0; }
  .inv-form{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .tiny{ font-size:12px; color:var(--muted); }
  .inv-table-wrap{
    margin-top:10px;
    max-height:360px;
    overflow:auto;
    border:1px solid var(--border);
    background:var(--panel);
  }
  table.inv-table th{ position:sticky; top:0; z-index:6; }
  table.inv-table td{ text-align:left; }
  table.inv-table td.num{ text-align:right; }
  a.inv-link{ color:#9fd3ff; text-decoration:none; }
  a.inv-link:hover{ text-decoration:underline; }

  .modal-backdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.75);
    display:none; align-items:center; justify-content:center;
    z-index: 9998;
    padding: 20px;
  }
  .modal{
    width: 100%;
    max-width: 720px;
    border:1px solid var(--border);
    background: var(--panel);
    padding: 14px;
  }
  .modal h3{ margin:0 0 10px 0; }
  .modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }
  .modal .inv-form{ grid-template-columns: 1fr 1fr; }

  @media (max-width: 1000px){
    .inv-grid{ grid-template-columns: 1fr; }
    th { position:static; }
  }

/* ===== Job Parts Picker (v1.8) ===== */
.jp-wrap{ margin-top:14px; padding-top:10px; border-top:1px solid #222; }
.jp-help{ color:#aaa; font-size:12px; margin:6px 0 10px; }
.jp-searchRow{ display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; }
.jp-searchRow .field{ flex:1; min-width:240px; }
.jp-suggestions{
  background:#0f0f0f;
  border:1px solid #333;
  border-radius:10px;
  margin-top:8px;
  max-height:220px;
  overflow:auto;
}
.jp-suggestion{
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid #222;
  display:grid;
  grid-template-columns: 90px 1fr auto;
  gap:10px;
  align-items:start;
}
.jp-suggestion:last-child{ border-bottom:none; }
.jp-suggestion:hover{ background:#171717; }
.jp-code{ font-weight:700; color:#d7d7d7; }
.jp-name{ color:#fff; }
.jp-meta{ color:#aaa; font-size:12px; white-space:nowrap; }
.jp-picked{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px; }
.jp-picked .pill{ border:1px solid #333; border-radius:999px; padding:6px 10px; color:#ddd; font-size:12px; }
.jp-table th{ white-space:nowrap; }

</style>
</head>

<body>

<div id="loginOverlay" class="login-overlay">
  <div class="login-card">
    <p class="login-title">Swan Security ‚Äì Login</p>
    <div class="login-grid">
      <div>
        <label>Username</label>
        <input id="loginUser" type="text" autocomplete="username" placeholder="e.g. lewis or luke">
      </div>
      <div>
        <label>Password</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="Password">
      </div>

      <div class="login-error" id="loginError"></div>

      <div class="login-actions">
        <button type="button" onclick="login()">Login</button>
        <button type="button" onclick="clearLoginFields()">Clear</button>
      </div>

      <div style="opacity:0.75;font-size:12px;line-height:1.4">
        Local login (single HTML file). When you move to a backend later, we‚Äôll secure this properly.
      </div>
    </div>
  </div>
</div>

<div id="app" class="app-hidden">

  <h2>
    Swan Security Services Ltd ‚Äì Quote Builder
    <span class="ver-badge">v17</span>
  </h2>

  <div class="dash" id="dashboardBar">
    <div class="dash-item"><label>Current Quote:</label> <strong id="dashQuote">‚Äî</strong></div>
    <div class="dash-item"><label>Status:</label> <strong id="dashStatus">Drafted</strong></div>
    <div class="dash-item"><label>Engineer:</label> <strong id="dashEngineer">‚Äî</strong></div>
    <div class="dash-item"><label>Last saved:</label> <strong id="dashSaved">‚Äî</strong></div>
    <div class="dash-spacer"></div>
    <div class="dash-item"><span class="pill" id="dashDraftPill">Draft: Off</span></div>
  </div>

  <div class="top-row">
    <label>Quote Number: <input type="text" id="quoteNumber" oninput="onAnyChange()"></label>

    <label>Status:
      <select id="quoteStatus" onchange="onAnyChange(); updateDash();">
        <option value="Drafted">Drafted</option>
        <option value="Sent">Sent</option>
        <option value="Accepted">Accepted</option>
        <option value="Processed">Processed</option>
      </select>
    </label>

    <button onclick="saveQuote()">Save Quote</button>

    <label>Load Quote: <input type="text" id="loadNumber"></label>
    <button onclick="loadQuote()">Load</button>

    <label>Find:
      <input class="quote-search" type="text" id="quoteFilter" placeholder="Search SS001 / Lewis / Luke" oninput="refreshSavedQuotesDropdown()">
    </label>

    <select id="savedQuotesSelect" class="saved-quotes" onchange="pickAndLoadSavedQuote(this.value)">
      <option value="">Saved Quotes‚Ä¶</option>
    </select>

    <button onclick="clearSheet()">Clear Sheet</button>
    <button onclick="exportInventoryTemplate()">Export Inventory (Workever)</button>
    <button onclick="document.getElementById('importFile').click()">Import Inventory (Workever)</button>
    <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none" onchange="importInventory(event)">

    <div class="user-pill" title="Logged in engineer">
      <small>Engineer:</small> <strong id="currentEngineerLabel">‚Äî</strong>
      <button type="button" onclick="logout()" style="padding:6px 10px;">Logout</button>
    </div>
  </div>

  <details class="inventory-panel" id="inventoryPanel">
    <summary>Inventory ‚Äì View / Add / Edit / Adjust Stock + Audit Trail</summary>

    <div class="inv-actions">
      <input id="invSearch" type="text" placeholder="Search inventory (SWA101 / BFT Mitto / keypad)" oninput="renderInventoryTable()">
      <button type="button" onclick="renderInventoryTable()">Refresh</button>
      <button type="button" onclick="exportInventoryTemplate()">Export Inventory (Workever)</button>
      <button type="button" onclick="document.getElementById('importFile').click()">Import Inventory (Workever)</button>
      <button type="button" onclick="resetInventoryToSeed()">Reset Inventory (Local)</button>
    </div>

    <div class="inv-grid">
      <div class="inv-box">
        <h4>Add New Inventory Item</h4>
        <div class="tiny">Product code must be <b>SWA</b> + number (example: <b>SWA154</b>). Duplicate codes are blocked.</div>

        <div class="inv-form" style="margin-top:10px;">
          <div>
            <div class="tiny">Product code</div>
            <input id="newCode" placeholder="SWA154">
          </div>
          <div>
            <div class="tiny">Item name</div>
            <input id="newName" placeholder="Item description">
          </div>
          <div>
            <div class="tiny">Purchases unit price</div>
            <input id="newCost" type="number" step="0.01" placeholder="0.00">
          </div>
          <div>
            <div class="tiny">Markup %</div>
            <input id="newMarkup" type="number" step="0.01" placeholder="40">
          </div>
          <div>
            <div class="tiny">Sales tax rate</div>
            <input id="newTax" type="number" step="0.01" placeholder="20">
          </div>
          <div>
            <div class="tiny">Quantity on hand</div>
            <input id="newQoh" type="number" step="1" placeholder="0">
          </div>
          <div>
            <div class="tiny">Stock location</div>
            <input id="newLoc" placeholder="General / Bay 1 / Lewis Van">
          </div>
          <div>
            <div class="tiny">URL</div>
            <input id="newUrl" placeholder="https://...">
          </div>
        </div>

        <div class="inv-actions">
          <button type="button" onclick="addNewInventoryItem()">Add Item</button>
        </div>
      </div>

      <div class="inv-box">
        <h4>Adjust Stock (Existing Item)</h4>
        <div class="tiny">Adds/subtracts to Quantity on Hand (e.g. +10 delivery, -2 used).</div>

        <div class="autocomplete-wrap" style="margin-top:10px;">
          <div class="tiny">Search product code / name</div>
          <input id="adjSearch" type="text" placeholder="Type SWA101 or name..." oninput="showAdjustSuggestions(this)">
          <div class="autocomplete-suggestions" id="adjSug"></div>
        </div>

        <div class="inv-form" style="margin-top:10px;">
          <div>
            <div class="tiny">Selected code</div>
            <input id="adjCode" readonly>
          </div>
          <div>
            <div class="tiny">Adjust by (+/-)</div>
            <input id="adjDelta" type="number" step="1" placeholder="5">
          </div>
        </div>

        <div class="inv-actions">
          <button type="button" onclick="applyStockAdjustment()">Apply Adjustment</button>
        </div>

        <div class="tiny" id="adjInfo" style="margin-top:8px;">‚Äî</div>
      </div>
    </div>

    <div class="inv-table-wrap">
      <table class="inv-table" id="invTable">
        <thead>
          <tr>
            <th>Product code</th>
            <th>Item name</th>
            <th>Cost</th>
            <th>Markup %</th>
            <th>Tax %</th>
            <th>QOH</th>
            <th>Location</th>
            <th>URL</th>
            <th style="min-width:140px;">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="inv-box" style="margin-top:12px;">
      <h4>Audit Trail (Parts Usage / Stock Changes)</h4>
      <div class="tiny">Shows where parts went once a quote is set to <b>Processed</b>, plus manual stock adjustments/imports.</div>

      <div class="inv-actions">
        <input id="auditSearch" type="text" placeholder="Filter (SWA101 / SS001 / Lewis)" oninput="renderAuditTable()">
        <button type="button" onclick="renderAuditTable()">Refresh</button>
        <button type="button" onclick="clearAuditTrail()">Clear Audit (Local)</button>
      </div>

      <div class="inv-table-wrap" style="max-height:260px;">
        <table class="inv-table" id="auditTable">
          <thead>
            <tr>
              <th style="min-width:160px;">When</th>
              <th>Engineer</th>
              <th>Quote</th>
              <th>Action</th>
              <th>Product code</th>
              <th class="num">Qty</th>
              <th class="num">Before</th>
              <th class="num">After</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="tiny" style="margin-top:8px;">
        Stock depletion happens once when a quote is first saved as <b>Processed</b>.
      </div>
    </div>

  </details>

  <button onclick="addRow()">+ Add Part</button>
  <button onclick="addLabourRow()">+ Add Labour</button>
  <button onclick="exportQuoteExcel()">Export Quote to Excel</button>

  <div class="section">
    <h3>Parts</h3>
    <table id="quoteTable">
      <thead>
        <tr>
          <th style="min-width:190px;">Part Number (Search)</th>
          <th style="min-width:220px;">Item Name</th>
          <th>Stock</th>
          <th>Qty</th>
          <th>Cost (¬£)</th>
          <th>Markup %</th>
          <th>Keep Manual Markup</th>
          <th>Link</th>
          <th>Net (¬£)</th>
          <th>Markup (¬£)</th>
          <th>Total (¬£)</th>
          <th>+1</th>
          <th>Duplicate</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Labour</h3>
    <table id="labourTable">
      <thead>
        <tr>
          <th>Labour Type</th>
          <th>Hours</th>
          <th>Rate (¬£/hr)</th>
          <th>Total (¬£)</th>
          <th>Duplicate</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Settings</h3>
    <label>
      VAT:
      <select id="vatToggle" onchange="recalc(); onAnyChange();">
        <option value="ex">EX VAT</option>
        <option value="inc">INC VAT</option>
      </select>
    </label>
  </div>

  <div class="section">
    <h3>Totals</h3>
    <p>Parts NET: ¬£<span id="partsNet">0.00</span></p>
    <p>Total Mark-Up: ¬£<span id="totalMarkup">0.00</span></p>
    <p>Labour Total: ¬£<span id="labourTotal">0.00</span></p>
    <p>VAT (20%): ¬£<span id="vatTotal">0.00</span></p>
    <p>Invoice Total: ¬£<span id="invoiceTotal">0.00</span></p>
  </div>

</div><!-- /app -->

<!-- Inventory Edit Modal -->
<div id="invModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Edit Inventory Item</h3>
    <div class="tiny" id="invModalHint">‚Äî</div>

    <div class="inv-form" style="margin-top:10px;">
      <div>
        <div class="tiny">Product code (locked)</div>
        <input id="editCode" readonly>
      </div>
      <div>
        <div class="tiny">Item name</div>
        <input id="editName">
      </div>
      <div>
        <div class="tiny">Purchases unit price</div>
        <input id="editCost" type="number" step="0.01">
      </div>
      <div>
        <div class="tiny">Markup %</div>
        <input id="editMarkup" type="number" step="0.01">
      </div>
      <div>
        <div class="tiny">Sales tax rate</div>
        <input id="editTax" type="number" step="0.01">
      </div>
      <div>
        <div class="tiny">Quantity on hand</div>
        <input id="editQoh" type="number" step="1">
      </div>
      <div>
        <div class="tiny">Stock location</div>
        <input id="editLoc">
      </div>
      <div>
        <div class="tiny">URL</div>
        <input id="editUrl">
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" onclick="closeInvModal()">Cancel</button>
      <button type="button" onclick="saveInvModal()">Save</button>
      <button type="button" onclick="deleteInvModal()" style="border-color:rgba(255,107,107,0.6);">Delete</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"><\/script>
<script>
const APP_VERSION = "v17";
const INVENTORY_STORAGE_KEY = "SwanInventory_v17";
const AUDIT_STORAGE_KEY = "SwanInventoryAudit_v17";

/* =========================
   LOGIN
   ========================= */
const USERS = [
  { username: "lewis", password: "Swan123!", engineer: "Lewis Winters" },
  { username: "luke",  password: "Swan123!", engineer: "Luke Scott" }
];

function setLoggedInEngineer(engineerName) {
  localStorage.setItem("SwanLoggedInEngineer", engineerName);
  document.getElementById("currentEngineerLabel").textContent = engineerName || "‚Äî";
}
function getLoggedInEngineer() {
  return localStorage.getItem("SwanLoggedInEngineer") || "";
}
function showLogin() {
  document.getElementById("app").classList.add("app-hidden");
  document.getElementById("loginOverlay").style.display = "flex";
  document.getElementById("loginError").textContent = "";
  document.getElementById("loginUser").focus();
}
function showApp() {
  document.getElementById("loginOverlay").style.display = "none";
  document.getElementById("app").classList.remove("app-hidden");
  setLoggedInEngineer(getLoggedInEngineer());

  refreshSavedQuotesDropdown();
  loadInventoryFromLocal();
  loadAuditFromLocal();
  renderInventoryTable();
  renderAuditTable();
  recalc();

  checkDraftAvailable();
}
function clearLoginFields() {
  document.getElementById("loginUser").value = "";
  document.getElementById("loginPass").value = "";
  document.getElementById("loginError").textContent = "";
}
function login() {
  const u = (document.getElementById("loginUser").value || "").trim().toLowerCase();
  const p = (document.getElementById("loginPass").value || "").trim();
  const match = USERS.find(x => x.username === u && x.password === p);
  if (!match) {
    document.getElementById("loginError").textContent = "Invalid username or password.";
    return;
  }
  setLoggedInEngineer(match.engineer);
  showApp();
}
function logout() {
  localStorage.removeItem("SwanLoggedInEngineer");
  clearLoginFields();
  showLogin();
}
document.addEventListener("keydown", (e) => {
  const overlayVisible = document.getElementById("loginOverlay").style.display === "flex";
  if (overlayVisible && e.key === "Enter") login();
});
window.addEventListener("load", () => {
  const eng = getLoggedInEngineer();
  if (!eng) showLogin();
  else showApp();
});

/* =========================
   INVENTORY
   ========================= */
let inventorySeed = {
  "SWA154": { name:"12v 1.5A PSU", cost:2.65, markup:250, salePrice:9.28, taxRate:20, qtyOnHand:-2, stockLocation:"General", stockLocationDesc:"General Location", replenishmentAlert:"", salesAccount:"Sales", salesDescription:"", supplier:"", url:"" },
  "SWA106": { name:"20mm Compression Gland (Black)", cost:0.19, markup:300, salePrice:0.76, taxRate:20, qtyOnHand:-8, stockLocation:"General", stockLocationDesc:"General Location", replenishmentAlert:"", salesAccount:"Sales", salesDescription:"", supplier:"", url:"" },
  "SWA101": { name:"BFT Mitto Cool 2 Button Remote", cost:18.00, markup:80, salePrice:32.40, taxRate:20, qtyOnHand:6, stockLocation:"Bay 1", stockLocationDesc:"Bay 1", replenishmentAlert:3, salesAccount:"Cost of Goods Sold", salesDescription:"", supplier:"", url:"" },
  "SWA186": { name:"DC60SS Keypad", cost:68.93, markup:35, salePrice:93.06, taxRate:20, qtyOnHand:-2, stockLocation:"General", stockLocationDesc:"General Location", replenishmentAlert:"", salesAccount:"Sales", salesDescription:"", supplier:"", url:"" },
  "SWA167": { name:"FAAC XT2 SLH Remote Black", cost:26.90, markup:40, salePrice:37.66, taxRate:20, qtyOnHand:-6, stockLocation:"General", stockLocationDesc:"General Location", replenishmentAlert:"", salesAccount:"Sales", salesDescription:"", supplier:"", url:"" },
  "SWA118": { name:"Wiska Box Black 85mm x 85mm", cost:2.85, markup:100, salePrice:5.70, taxRate:20, qtyOnHand:-1, stockLocation:"General", stockLocationDesc:"General Location", replenishmentAlert:"", salesAccount:"Sales", salesDescription:"", supplier:"", url:"" }
};
let inventory = JSON.parse(JSON.stringify(inventorySeed));

function saveInventoryToLocal(){
  try { localStorage.setItem(INVENTORY_STORAGE_KEY, JSON.stringify(inventory)); }
  catch(e){ alert("Could not save inventory locally (storage blocked/full)."); }
}
function loadInventoryFromLocal(){
  try{
    const raw = localStorage.getItem(INVENTORY_STORAGE_KEY);
    if (!raw) return;
    const obj = JSON.parse(raw);
    if (obj && typeof obj === "object") inventory = obj;
  }catch(e){}
}
function resetInventoryToSeed(){
  if(!confirm("Reset inventory to the built-in seed? (Local only)")) return;
  inventory = JSON.parse(JSON.stringify(inventorySeed));
  saveInventoryToLocal();
  addAudit({ action:"RESET_INVENTORY", note:"Inventory reset to seed", qty:"", code:"", before:"", after:"" });
  renderInventoryTable();
  renderAuditTable();
  recalc();
}

/* =========================
   AUDIT TRAIL
   ========================= */
let auditTrail = [];

function saveAuditToLocal(){
  try { localStorage.setItem(AUDIT_STORAGE_KEY, JSON.stringify(auditTrail)); }
  catch(e){ alert("Could not save audit trail locally."); }
}
function loadAuditFromLocal(){
  try{
    const raw = localStorage.getItem(AUDIT_STORAGE_KEY);
    auditTrail = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(auditTrail)) auditTrail = [];
  }catch(e){ auditTrail = []; }
}
function addAudit({ action, code, qty, before, after, quoteNumber, engineer, note }){
  const entry = {
    when: new Date().toISOString(),
    engineer: engineer || getLoggedInEngineer() || "",
    quote: quoteNumber || (document.getElementById("quoteNumber")?.value || "").trim(),
    action: action || "",
    code: code || "",
    qty: qty ?? "",
    before: before ?? "",
    after: after ?? "",
    note: note || ""
  };
  auditTrail.unshift(entry);
  auditTrail = auditTrail.slice(0, 2000);
  saveAuditToLocal();
}
function renderAuditTable(){
  const tbody = document.querySelector("#auditTable tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  const q = (document.getElementById("auditSearch")?.value || "").trim().toLowerCase();
  const rows = auditTrail.slice(0, 500);

  for (const a of rows){
    const blob = \`\${a.when} \${a.engineer} \${a.quote} \${a.action} \${a.code} \${a.note}\`.toLowerCase();
    if (q && !blob.includes(q)) continue;

    const tr = document.createElement("tr");
    tr.innerHTML = \`
      <td>\${escapeHtml(formatIso(a.when))}</td>
      <td>\${escapeHtml(a.engineer || "")}</td>
      <td>\${escapeHtml(a.quote || "")}</td>
      <td>\${escapeHtml(a.action || "")}</td>
      <td>\${escapeHtml(a.code || "")}</td>
      <td class="num">\${escapeHtml(String(a.qty ?? ""))}</td>
      <td class="num">\${escapeHtml(String(a.before ?? ""))}</td>
      <td class="num">\${escapeHtml(String(a.after ?? ""))}</td>
      <td>\${escapeHtml(a.note || "")}</td>
    \`;
    tbody.appendChild(tr);
  }
}
function clearAuditTrail(){
  if(!confirm("Clear the audit trail (local only)?")) return;
  auditTrail = [];
  saveAuditToLocal();
  renderAuditTable();
}

/* =========================
   INVENTORY VIEW / ADD / EDIT / DELETE
   ========================= */
function renderInventoryTable(){
  const tbody = document.querySelector("#invTable tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  const q = (document.getElementById("invSearch")?.value || "").trim().toLowerCase();
  const codes = Object.keys(inventory).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true, sensitivity:"base"}));

  for (const code of codes){
    const it = inventory[code] || {};
    const name = String(it.name || "");
    if (q && !(code.toLowerCase().includes(q) || name.toLowerCase().includes(q))) continue;

    const url = String(it.url || "").trim();
    const tr = document.createElement("tr");
    tr.innerHTML = \`
      <td>\${escapeHtml(code)}</td>
      <td>\${escapeHtml(name)}</td>
      <td class="num">\${fmt(it.cost)}</td>
      <td class="num">\${fmt(it.markup)}</td>
      <td class="num">\${fmt(it.taxRate ?? 20)}</td>
      <td class="num">\${fmt(it.qtyOnHand)}</td>
      <td>\${escapeHtml(it.stockLocation || "")}</td>
      <td>\${url ? \`<a class="inv-link" href="\${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">Open</a>\` : ""}</td>
      <td>
        <button type="button" class="mini-btn" onclick="openInvModal('\${escapeAttr(code)}')">Edit</button>
        <button type="button" class="mini-btn" onclick="deleteInventory('\${escapeAttr(code)}')" style="border-color:rgba(255,107,107,0.6);">Delete</button>
      </td>
    \`;
    tbody.appendChild(tr);
  }
}

function normalizeAndValidateCode(raw){
  const c = String(raw || "").trim().toUpperCase().replace(/\\s+/g,'');
  if (!/^SWA\\d+$/.test(c)) return { ok:false, code:c };
  return { ok:true, code:c };
}

function addNewInventoryItem(){
  const { ok, code } = normalizeAndValidateCode(document.getElementById("newCode").value);
  const name = (document.getElementById("newName").value || "").trim();

  if (!ok){
    alert("Product code must be SWA + number (example: SWA154).");
    return;
  }
  if (!name){
    alert("Item name is required.");
    return;
  }
  if (inventory[code]){
    alert("That product code already exists. Duplicate codes are blocked.");
    return;
  }

  const cost = toNumber(document.getElementById("newCost").value);
  const markup = toNumber(document.getElementById("newMarkup").value);
  const tax = toNumber(document.getElementById("newTax").value);
  const qoh = toNumber(document.getElementById("newQoh").value);
  const loc = (document.getElementById("newLoc").value || "").trim();
  const url = (document.getElementById("newUrl").value || "").trim();

  inventory[code] = {
    name,
    cost: Number.isFinite(cost) ? cost : 0,
    markup: Number.isFinite(markup) ? markup : 0,
    salePrice: "",
    taxRate: Number.isFinite(tax) ? tax : 20,
    qtyOnHand: Number.isFinite(qoh) ? qoh : 0,
    stockLocation: loc,
    stockLocationDesc: "",
    replenishmentAlert: "",
    salesAccount: "Sales",
    salesDescription: "",
    supplier: "",
    url
  };

  ["newCode","newName","newCost","newMarkup","newTax","newQoh","newLoc","newUrl"].forEach(id => document.getElementById(id).value = "");
  saveInventoryToLocal();

  addAudit({ action:"ADD_ITEM", code, qty:"", before:"", after: inventory[code].qtyOnHand, note: name });
  renderInventoryTable();
  renderAuditTable();
  recalc();
  alert(\`Added \${code} to inventory. It will be included in Workever export.\`);
}

/* Adjust stock */
function showAdjustSuggestions(input){
  const val = (input.value || "").toLowerCase().trim();
  const container = document.getElementById("adjSug");
  container.innerHTML = "";
  if (!val) return;

  Object.keys(inventory).forEach(code=>{
    const it = inventory[code];
    const nm = String(it?.name || "");
    if (code.toLowerCase().includes(val) || nm.toLowerCase().includes(val)){
      const div = document.createElement("div");
      div.className = "autocomplete-suggestion";
      div.textContent = \`\${code} ‚Äì \${nm}\`;
      div.onclick = () => {
        document.getElementById("adjCode").value = code;
        document.getElementById("adjSearch").value = \`\${code} ‚Äì \${nm}\`;
        container.innerHTML = "";
        updateAdjInfo(code);
      };
      container.appendChild(div);
    }
  });
}
function updateAdjInfo(code){
  const it = inventory[code];
  const info = document.getElementById("adjInfo");
  if (!it){ info.textContent="‚Äî"; return; }
  info.textContent = \`Current QOH for \${code}: \${fmt(it.qtyOnHand)} (\${it.stockLocation || "No location"})\`;
}
function applyStockAdjustment(){
  const code = (document.getElementById("adjCode").value || "").trim().toUpperCase();
  if (!code || !inventory[code]){
    alert("Select a valid inventory item first.");
    return;
  }
  const delta = toNumber(document.getElementById("adjDelta").value);
  if (!Number.isFinite(delta) || delta === 0){
    alert("Enter a valid adjustment amount (e.g. 5 or -2).");
    return;
  }
  const before = toNumber(inventory[code].qtyOnHand);
  const safeBefore = Number.isFinite(before) ? before : 0;
  const after = safeBefore + delta;
  inventory[code].qtyOnHand = after;

  document.getElementById("adjDelta").value = "";
  saveInventoryToLocal();

  addAudit({ action:"ADJUST_STOCK", code, qty: delta, before: safeBefore, after, note:"Manual adjustment" });
  renderInventoryTable();
  renderAuditTable();
  updateAdjInfo(code);
  recalc();
  alert(\`Adjusted \${code} by \${delta}. New QOH: \${inventory[code].qtyOnHand}\`);
}

/* Modal edit/delete */
function openInvModal(code){
  const it = inventory[code];
  if (!it) return;

  document.getElementById("invModalHint").textContent = \`Editing \${code}\`;
  document.getElementById("editCode").value = code;
  document.getElementById("editName").value = it.name || "";
  document.getElementById("editCost").value = toNumber(it.cost) || 0;
  document.getElementById("editMarkup").value = toNumber(it.markup) || 0;
  document.getElementById("editTax").value = toNumber(it.taxRate ?? 20) || 20;
  document.getElementById("editQoh").value = (Number.isFinite(toNumber(it.qtyOnHand)) ? toNumber(it.qtyOnHand) : 0);
  document.getElementById("editLoc").value = it.stockLocation || "";
  document.getElementById("editUrl").value = it.url || "";

  document.getElementById("invModalBackdrop").style.display = "flex";
}
function closeInvModal(){
  document.getElementById("invModalBackdrop").style.display = "none";
}
function saveInvModal(){
  const code = (document.getElementById("editCode").value || "").trim().toUpperCase();
  if (!inventory[code]) { closeInvModal(); return; }

  const beforeQ = toNumber(inventory[code].qtyOnHand);
  const beforeSafe = Number.isFinite(beforeQ) ? beforeQ : 0;

  inventory[code].name = (document.getElementById("editName").value || "").trim();
  inventory[code].cost = toNumber(document.getElementById("editCost").value) || 0;
  inventory[code].markup = toNumber(document.getElementById("editMarkup").value) || 0;
  inventory[code].taxRate = toNumber(document.getElementById("editTax").value) || 20;
  inventory[code].qtyOnHand = toNumber(document.getElementById("editQoh").value) || 0;
  inventory[code].stockLocation = (document.getElementById("editLoc").value || "").trim();
  inventory[code].url = (document.getElementById("editUrl").value || "").trim();

  saveInventoryToLocal();
  addAudit({ action:"EDIT_ITEM", code, qty:"", before: beforeSafe, after: inventory[code].qtyOnHand, note:"Edited item fields" });

  closeInvModal();
  renderInventoryTable();
  renderAuditTable();
  recalc();
}
function deleteInvModal(){
  const code = (document.getElementById("editCode").value || "").trim().toUpperCase();
  closeInvModal();
  deleteInventory(code);
}
function deleteInventory(code){
  if (!inventory[code]) return;
  if (!confirm(\`Delete inventory item \${code}?\`)) return;

  const before = toNumber(inventory[code].qtyOnHand);
  const safeBefore = Number.isFinite(before) ? before : "";
  const name = inventory[code].name || "";

  delete inventory[code];
  saveInventoryToLocal();

  addAudit({ action:"DELETE_ITEM", code, qty:"", before: safeBefore, after:"", note: name });
  renderInventoryTable();
  renderAuditTable();
  recalc();
}

/* =========================
   DRAFT AUTOSAVE (same style)
   ========================= */
const DRAFT_KEY = "SwanDraftV17";
let isDirty = false;
let lastSavedAt = "";
let draftTimer = null;

function onAnyChange(){
  isDirty = true;
  updateDraftPill(true);
  updateDash();
}

function updateDraftPill(on){
  const el = document.getElementById("dashDraftPill");
  if (!el) return;
  el.textContent = on ? "Draft: On" : "Draft: Off";
  el.className = "pill " + (on ? "ok" : "");
}

function checkDraftAvailable(){
  try{
    const d = JSON.parse(localStorage.getItem(DRAFT_KEY) || "null");
    if (!d) return;
    const eng = getLoggedInEngineer();
    if (!eng || d.engineer !== eng) return;
    const nowQuote = (document.getElementById("quoteNumber").value || "").trim();
    if (nowQuote) return;

    const ok = confirm(\`Draft found for \${d.engineer} (Quote: \${d.quoteNumber || "UNASSIGNED"}). Restore it?\`);
    if (ok) restoreDraft(d);
  }catch(e){}
}

function restoreDraft(d){
  document.getElementById("quoteNumber").value = d.quoteNumber || "";
  document.getElementById("quoteStatus").value = d.status || "Drafted";
  document.getElementById("vatToggle").value = d.vat || "ex";

  document.querySelector("#quoteTable tbody").innerHTML = "";
  document.querySelector("#labourTable tbody").innerHTML = "";

  (d.parts || []).forEach(p => {
    addRow();
    const r = document.querySelector("#quoteTable tbody tr:last-child");
    r.querySelector(".partSearch").value = p.partNumber || "";
    r.querySelector(".itemName").value = p.itemName || "";
    r.querySelector(".qty").value = p.qty ?? 1;
    r.querySelector(".cost").value = p.cost ?? 0;
    r.querySelector(".markup").value = p.markup ?? 0;
    r.querySelector(".keepMarkup").checked = !!p.keepMarkup;
    r.dataset.url = p.url || "";
    r.dataset.stockCode = p.partNumber || "";
    if (p.presetMarkup !== undefined) r.dataset.presetMarkup = p.presetMarkup;
    updateMarkupVisual(r);
  });

  (d.labour || []).forEach(l => {
    addLabourRow();
    const r = document.querySelector("#labourTable tbody tr:last-child");
    r.querySelector(".labType").value = l.type || labourTypes[0];
    r.querySelector(".hours").value = l.hours ?? 0;
    r.querySelector(".rate").value = l.rate ?? 0;
  });

  isDirty = true;
  updateDraftPill(true);
  recalc();
  updateDash();
}

function startDraftAutosave(){
  if (draftTimer) clearInterval(draftTimer);
  draftTimer = setInterval(() => {
    if (!isDirty) return;
    autosaveDraft();
  }, 15000);
}

function autosaveDraft(){
  const engineer = getLoggedInEngineer();
  if (!engineer) return;

  const quoteNumber = (document.getElementById("quoteNumber").value || "").trim();
  const status = document.getElementById("quoteStatus").value || "Drafted";
  const vat = document.getElementById("vatToggle").value || "ex";

  const draft = {
    version: APP_VERSION,
    savedAt: new Date().toISOString(),
    engineer,
    quoteNumber,
    status,
    vat,
    parts: [],
    labour: []
  };

  document.querySelectorAll("#quoteTable tbody tr").forEach(row => {
    draft.parts.push({
      partNumber: row.querySelector(".partSearch")?.value || "",
      itemName: row.querySelector(".itemName")?.value || "",
      qty: row.querySelector(".qty")?.value || "",
      cost: row.querySelector(".cost")?.value || "",
      markup: row.querySelector(".markup")?.value || "",
      keepMarkup: row.querySelector(".keepMarkup")?.checked || false,
      url: row.dataset.url || "",
      presetMarkup: row.dataset.presetMarkup
    });
  });

  document.querySelectorAll("#labourTable tbody tr").forEach(row => {
    draft.labour.push({
      type: row.querySelector(".labType")?.value || "",
      hours: row.querySelector(".hours")?.value || "",
      rate: row.querySelector(".rate")?.value || ""
    });
  });

  localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
  lastSavedAt = timeNow();
  document.getElementById("dashSaved").textContent = lastSavedAt + " (draft)";
  isDirty = false;
  updateDraftPill(false);
}

function timeNow(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return \`\${hh}:\${mm}\`;
}

startDraftAutosave();

/* =========================
   MARKUP VISUAL STATE
   ========================= */
function updateMarkupVisual(row){
  const input = row.querySelector(".markup");
  const note = row.querySelector(".markupNote");
  if (!input || !note) return;

  const presetRaw = row.dataset.presetMarkup;
  if (presetRaw === undefined || presetRaw === "") {
    input.classList.remove("markup-preset");
    note.textContent = "";
    note.className = "markup-note markupNote";
    return;
  }

  const preset = parseFloat(presetRaw);
  const current = parseFloat(input.value);

  if (Number.isFinite(preset) && Number.isFinite(current) && current === preset) {
    input.classList.add("markup-preset");
    note.textContent = "Preset";
    note.className = "markup-note markupNote preset";
  } else {
    input.classList.remove("markup-preset");
    note.textContent = \`Modified (was \${preset}%)\`;
    note.className = "markup-note markupNote modified";
  }
}
function onMarkupTyping(input){ updateMarkupVisual(input.closest("tr")); }
function onMarkupEdited(input){
  const row = input.closest("tr");
  const keep = row.querySelector(".keepMarkup");
  if (keep) keep.checked = true;
  updateMarkupVisual(row);
}

/* =========================
   PARTS + SEARCH
   ========================= */
const labourTypes = ["Fabrication","1st Fix","2nd Fix","Travel","Drawing","Planning","Research","Survey","Photocell/Intercom"];

function addRow() {
  const tbody = document.querySelector("#quoteTable tbody");
  const tr = document.createElement("tr");
  tr.dataset.url = "";
  tr.dataset.stockCode = "";
  tr.dataset.presetMarkup = "";

  tr.innerHTML = \`
    <td class="autocomplete-wrap">
      <input class="partSearch" type="text" placeholder="Type SWA101 or 'BFT Mitto'..." oninput="showSuggestions(this)" />
      <div class="autocomplete-suggestions"></div>
    </td>
    <td><input class="itemName" type="text" onchange="recalc(); onAnyChange()"></td>
    <td class="stockCell"><span class="pill">‚Äî</span></td>
    <td><input class="qty" type="number" value="1" min="0" step="1" onchange="recalc(); onAnyChange()"></td>
    <td><input class="cost" type="number" step="0.01" onchange="recalc(); onAnyChange()"></td>
    <td>
      <div class="markup-wrap">
        <input class="markup" type="number" onchange="recalc(); onAnyChange(); onMarkupEdited(this)" oninput="onMarkupTyping(this)">
        <div class="markup-note markupNote"></div>
      </div>
    </td>
    <td>
      <div class="toggle-wrap" title="If ticked, selecting the same part again won‚Äôt overwrite your manual markup">
        <input class="keepMarkup" type="checkbox" onchange="onAnyChange(); updateMarkupVisual(this.closest('tr'))">
        <span style="color:var(--muted);font-size:12px;">Keep</span>
      </div>
    </td>
    <td>
      <button type="button" class="mini-btn" onclick="openRowUrl(this)" title="Open supplier link">üîó</button>
    </td>
    <td class="right netCell">0.00</td>
    <td class="right markCell">0.00</td>
    <td class="right totalCell">0.00</td>
    <td><button type="button" class="mini-btn" onclick="incQty(this)">+1</button></td>
    <td><button type="button" class="mini-btn" onclick="duplicatePartRow(this)">Copy</button></td>
    <td><button type="button" class="mini-btn" onclick="this.closest('tr').remove(); recalc(); onAnyChange()">Del</button></td>
  \`;
  tbody.appendChild(tr);

  const input = tr.querySelector(".partSearch");
  input.addEventListener("blur", () => {
    setTimeout(() => {
      const cont = input.nextElementSibling;
      if (cont) cont.innerHTML = "";
    }, 150);
  });

  onAnyChange();
  recalc();
}

function showSuggestions(input) {
  const val = (input.value || "").toLowerCase().trim();
  const container = input.nextElementSibling;
  container.innerHTML = '';
  if (!val) return;

  const results = Object.keys(inventory)
    .map(code => ({ code, item: inventory[code] }))
    .filter(x => {
      const c = x.code.toLowerCase();
      const n = (x.item?.name || "").toLowerCase();
      return c.includes(val) || n.includes(val);
    })
    .sort((a,b) => scoreMatch(a, val) - scoreMatch(b, val))
    .slice(0, 30);

  results.forEach(({code, item}) => {
    const div = document.createElement("div");
    div.classList.add("autocomplete-suggestion");
    div.textContent = \`\${code} ‚Äì \${item.name}\`;
    div.onclick = () => applyInventoryToRow(input, code);
    container.appendChild(div);
  });
}

function scoreMatch(entry, val) {
  const c = entry.code.toLowerCase();
  const n = (entry.item?.name || "").toLowerCase();
  if (c === val) return 0;
  if (c.startsWith(val)) return 1;
  if (c.includes(val)) return 2;
  if (n.startsWith(val)) return 3;
  if (n.includes(val)) return 4;
  return 99;
}

function applyInventoryToRow(input, code) {
  const item = inventory[code];
  if (!item) return;

  const row = input.closest("tr");
  const keep = row.querySelector(".keepMarkup")?.checked;

  row.querySelector(".partSearch").value = code;
  row.querySelector(".itemName").value = item.name ?? "";
  row.querySelector(".cost").value = item.cost ?? 0;

  row.dataset.presetMarkup = (item.markup ?? 0);
  if (!keep) row.querySelector(".markup").value = item.markup ?? 0;

  row.dataset.url = item.url ?? "";
  row.dataset.stockCode = code;

  input.nextElementSibling.innerHTML = "";

  updateMarkupVisual(row);
  recalc();
  onAnyChange();
}

function openRowUrl(btn){
  const row = btn.closest("tr");
  const url = (row.dataset.url || "").trim();
  if (!url){
    const code = row.querySelector(".partSearch")?.value?.trim();
    if (code && inventory[code]?.url) {
      window.open(inventory[code].url, "_blank", "noopener,noreferrer");
      return;
    }
    alert("No URL saved for this item (import Workever file with URL column).");
    return;
  }
  window.open(url, "_blank", "noopener,noreferrer");
}

function incQty(btn){
  const row = btn.closest("tr");
  const qty = row.querySelector(".qty");
  const v = parseFloat(qty.value) || 0;
  qty.value = (v + 1);
  recalc();
  onAnyChange();
}

function duplicatePartRow(btn){
  const row = btn.closest("tr");
  const data = {
    part: row.querySelector(".partSearch")?.value || "",
    name: row.querySelector(".itemName")?.value || "",
    qty: row.querySelector(".qty")?.value || "1",
    cost: row.querySelector(".cost")?.value || "",
    markup: row.querySelector(".markup")?.value || "",
    keep: row.querySelector(".keepMarkup")?.checked || false,
    url: row.dataset.url || "",
    stockCode: row.dataset.stockCode || "",
    presetMarkup: row.dataset.presetMarkup || ""
  };
  addRow();
  const r = document.querySelector("#quoteTable tbody tr:last-child");
  r.querySelector(".partSearch").value = data.part;
  r.querySelector(".itemName").value = data.name;
  r.querySelector(".qty").value = data.qty;
  r.querySelector(".cost").value = data.cost;
  r.querySelector(".markup").value = data.markup;
  r.querySelector(".keepMarkup").checked = data.keep;
  r.dataset.url = data.url;
  r.dataset.stockCode = data.stockCode;
  r.dataset.presetMarkup = data.presetMarkup;
  updateMarkupVisual(r);
  recalc();
  onAnyChange();
}

/* =========================
   LABOUR
   ========================= */
function addLabourRow() {
  const tbody = document.querySelector("#labourTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = \`
    <td>
      <select class="labType" onchange="recalc(); onAnyChange()">
        \${labourTypes.map(type => \`<option>\${type}</option>\`).join("")}
      </select>
    </td>
    <td><input class="hours" type="number" value="1" min="0" step="0.25" onchange="recalc(); onAnyChange()"></td>
    <td><input class="rate" type="number" value="50" step="0.01" onchange="recalc(); onAnyChange()"></td>
    <td class="right labTotalCell">0.00</td>
    <td><button type="button" class="mini-btn" onclick="duplicateLabourRow(this)">Copy</button></td>
    <td><button type="button" class="mini-btn" onclick="this.closest('tr').remove(); recalc(); onAnyChange()">Del</button></td>
  \`;
  tbody.appendChild(tr);
  recalc();
  onAnyChange();
}

function duplicateLabourRow(btn){
  const row = btn.closest("tr");
  const data = {
    type: row.querySelector(".labType")?.value || labourTypes[0],
    hours: row.querySelector(".hours")?.value || "0",
    rate: row.querySelector(".rate")?.value || "0"
  };
  addLabourRow();
  const r = document.querySelector("#labourTable tbody tr:last-child");
  r.querySelector(".labType").value = data.type;
  r.querySelector(".hours").value = data.hours;
  r.querySelector(".rate").value = data.rate;
  recalc();
  onAnyChange();
}

/* =========================
   RECALC
   ========================= */
function recalc() {
  let partsNet = 0, totalMarkup = 0, labourTotal = 0;

  document.querySelectorAll("#quoteTable tbody tr").forEach(row => {
    const qty = parseFloat(row.querySelector(".qty")?.value) || 0;
    const cost = parseFloat(row.querySelector(".cost")?.value) || 0;
    const markupPct = parseFloat(row.querySelector(".markup")?.value) || 0;

    const net = qty * cost;
    const markup = net * (markupPct / 100);
    const total = net + markup;

    row.querySelector(".netCell").textContent = net.toFixed(2);
    row.querySelector(".markCell").textContent = markup.toFixed(2);
    row.querySelector(".totalCell").textContent = total.toFixed(2);

    partsNet += net;
    totalMarkup += markup;

    applyStockWarning(row);
    updateMarkupVisual(row);
  });

  document.querySelectorAll("#labourTable tbody tr").forEach(row => {
    const hours = parseFloat(row.querySelector(".hours")?.value) || 0;
    const rate = parseFloat(row.querySelector(".rate")?.value) || 0;
    const total = hours * rate;
    row.querySelector(".labTotalCell").textContent = total.toFixed(2);
    labourTotal += total;
  });

  let invoiceExVAT = partsNet + totalMarkup + labourTotal;
  let vatTotal = 0;
  if (document.getElementById("vatToggle").value === "inc") vatTotal = invoiceExVAT * 0.20;

  document.getElementById("partsNet").textContent = partsNet.toFixed(2);
  document.getElementById("totalMarkup").textContent = totalMarkup.toFixed(2);
  document.getElementById("labourTotal").textContent = labourTotal.toFixed(2);
  document.getElementById("vatTotal").textContent = vatTotal.toFixed(2);
  document.getElementById("invoiceTotal").textContent = (invoiceExVAT + vatTotal).toFixed(2);

  updateDash();
}

function applyStockWarning(row){
  row.classList.remove("stock-low","stock-negative");

  const code = (row.dataset.stockCode || row.querySelector(".partSearch")?.value || "").trim();
  const cell = row.querySelector(".stockCell");
  if (!cell) return;

  if (!code || !inventory[code]){
    cell.innerHTML = \`<span class="pill">‚Äî</span>\`;
    return;
  }

  const item = inventory[code];
  const qoh = toNumber(item.qtyOnHand);
  const repl = toNumber(item.replenishmentAlert);

  let txt = "";
  let klass = "pill";
  if (Number.isFinite(qoh)) {
    txt = \`QOH: \${qoh}\`;
    if (Number.isFinite(repl) && qoh <= repl) {
      klass += " warn";
      row.classList.add("stock-low");
    }
    if (qoh < 0) {
      klass = "pill bad";
      row.classList.add("stock-negative");
    }
    if (qoh > 0 && (!Number.isFinite(repl) || qoh > repl)) {
      klass = "pill ok";
    }
  } else {
    txt = "QOH: ‚Äî";
  }

  const loc = (item.stockLocation || "").trim();
  const locTxt = loc ? \` ‚Ä¢ \${loc}\` : "";
  cell.innerHTML = \`<span class="\${klass}" title="Quantity on hand from Workever\${locTxt}">\${txt}\${locTxt}</span>\`;
}

/* =========================
   DASH
   ========================= */
function updateDash(){
  const q = (document.getElementById("quoteNumber").value || "").trim();
  const s = document.getElementById("quoteStatus").value || "Drafted";
  const eng = getLoggedInEngineer() || "‚Äî";
  document.getElementById("dashQuote").textContent = q || "‚Äî";
  document.getElementById("dashStatus").textContent = s;
  document.getElementById("dashEngineer").textContent = eng;
  if (!document.getElementById("dashSaved").textContent || document.getElementById("dashSaved").textContent === "‚Äî") {
    document.getElementById("dashSaved").textContent = lastSavedAt || "‚Äî";
  }
}

/* =========================
   QUOTES SAVE/LOAD + STOCK DEPLETION ON PROCESSED
   ========================= */
function saveQuote() {
  const quoteNumber = document.getElementById("quoteNumber").value.trim();
  if (!quoteNumber) { alert("Enter a Quote Number"); return; }

  const engineer = getLoggedInEngineer();
  if (!engineer) { alert("You are not logged in."); showLogin(); return; }

  const storedQuotes = JSON.parse(localStorage.getItem("SwanQuotes") || "{}");
  const prev = storedQuotes[quoteNumber];
  const prevStatus = prev?.status || "";

  const status = document.getElementById("quoteStatus").value;

  const quoteData = {
    version: APP_VERSION,
    status,
    engineer: engineer,
    savedAt: new Date().toISOString(),
    processedAt: prev?.processedAt || "",
    parts: [],
    labour: [],
    vat: document.getElementById("vatToggle").value
  };

  document.querySelectorAll("#quoteTable tbody tr").forEach(row => {
    quoteData.parts.push({
      partNumber: row.querySelector(".partSearch")?.value || "",
      itemName: row.querySelector(".itemName")?.value || "",
      qty: row.querySelector(".qty")?.value || "",
      cost: row.querySelector(".cost")?.value || "",
      markup: row.querySelector(".markup")?.value || "",
      keepMarkup: row.querySelector(".keepMarkup")?.checked || false,
      url: row.dataset.url || "",
      presetMarkup: row.dataset.presetMarkup || ""
    });
  });

  document.querySelectorAll("#labourTable tbody tr").forEach(row => {
    quoteData.labour.push({
      type: row.querySelector(".labType")?.value || "",
      hours: row.querySelector(".hours")?.value || "",
      rate: row.querySelector(".rate")?.value || ""
    });
  });

  // IMPORTANT: process stock only when transitioning to Processed for the FIRST time
  if (status === "Processed" && prevStatus !== "Processed") {
    const ok = confirm("This will PROCESS the quote and DECREASE stock levels for any SWA parts used. Continue?");
    if (!ok) {
      // revert UI status back to previous
      document.getElementById("quoteStatus").value = prevStatus || "Drafted";
      quoteData.status = document.getElementById("quoteStatus").value;
    } else {
      quoteData.processedAt = new Date().toISOString();
      processQuoteStock(quoteNumber, engineer, quoteData.parts);
    }
  }

  storedQuotes[quoteNumber] = quoteData;
  localStorage.setItem("SwanQuotes", JSON.stringify(storedQuotes));

  document.getElementById("loadNumber").value = quoteNumber;
  lastSavedAt = timeNow();
  document.getElementById("dashSaved").textContent = \`\${lastSavedAt} (saved)\`;
  isDirty = false;
  updateDraftPill(false);
  refreshSavedQuotesDropdown();

  try{
    const d = JSON.parse(localStorage.getItem(DRAFT_KEY) || "null");
    if (d && d.engineer === engineer) localStorage.removeItem(DRAFT_KEY);
  }catch(e){}

  renderInventoryTable();
  renderAuditTable();
  recalc();
  alert(\`Quote saved successfully! (Engineer: \${engineer})\`);
}

function processQuoteStock(quoteNumber, engineer, parts){
  // Deduct from inventory for each part line with a valid inventory code
  for (const p of (parts || [])) {
    const code = String(p.partNumber || "").trim().toUpperCase();
    const qty = toNumber(p.qty);

    if (!code || !inventory[code]) continue;
    if (!Number.isFinite(qty) || qty <= 0) continue;

    const before = toNumber(inventory[code].qtyOnHand);
    const safeBefore = Number.isFinite(before) ? before : 0;
    const after = safeBefore - qty;
    inventory[code].qtyOnHand = after;

    addAudit({
      action: "PROCESS_DEDUCT",
      code,
      qty,
      before: safeBefore,
      after,
      quoteNumber,
      engineer,
      note: "Deducted on Processed status"
    });
  }

  saveInventoryToLocal();
}

function loadQuote() {
  const loadNumber = document.getElementById("loadNumber").value.trim();
  if (!loadNumber) { alert("Enter a Quote Number"); return; }
  loadQuoteByNumber(loadNumber);
}

function loadQuoteByNumber(quoteNumber) {
  const storedQuotes = JSON.parse(localStorage.getItem("SwanQuotes") || "{}");
  const quoteData = storedQuotes[quoteNumber];
  if (!quoteData) { alert("Quote not found."); return; }

  document.getElementById("loadNumber").value = quoteNumber;
  document.getElementById("quoteNumber").value = quoteNumber;

  document.querySelector("#quoteTable tbody").innerHTML = "";
  document.querySelector("#labourTable tbody").innerHTML = "";

  (quoteData.parts || []).forEach(part => {
    addRow();
    const r = document.querySelector("#quoteTable tbody tr:last-child");
    r.querySelector(".partSearch").value = part.partNumber || "";
    r.querySelector(".itemName").value = part.itemName || "";
    r.querySelector(".qty").value = part.qty ?? 1;
    r.querySelector(".cost").value = part.cost ?? 0;
    r.querySelector(".markup").value = part.markup ?? 0;
    r.querySelector(".keepMarkup").checked = !!part.keepMarkup;

    const code = (part.partNumber || "").trim();
    r.dataset.stockCode = code;
    r.dataset.url = part.url || (inventory[code]?.url || "");
    r.dataset.presetMarkup = part.presetMarkup !== undefined ? part.presetMarkup : (inventory[code]?.markup ?? "");

    updateMarkupVisual(r);
  });

  (quoteData.labour || []).forEach(lab => {
    addLabourRow();
    const r = document.querySelector("#labourTable tbody tr:last-child");
    r.querySelector(".labType").value = lab.type || labourTypes[0];
    r.querySelector(".hours").value = lab.hours ?? 0;
    r.querySelector(".rate").value = lab.rate ?? 0;
  });

  document.getElementById("vatToggle").value = quoteData.vat || "ex";
  document.getElementById("quoteStatus").value = quoteData.status || "Drafted";

  lastSavedAt = quoteData.savedAt ? formatSavedAt(quoteData.savedAt) : timeNow();
  document.getElementById("dashSaved").textContent = \`\${lastSavedAt} (loaded)\`;

  isDirty = false;
  updateDraftPill(false);

  recalc();
  updateDash();
}

function formatSavedAt(iso){
  try{
    const d = new Date(iso);
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return \`\${hh}:\${mm}\`;
  }catch(e){
    return timeNow();
  }
}

function pickAndLoadSavedQuote(quoteNo) {
  if (!quoteNo) return;
  loadQuoteByNumber(quoteNo);
}

function refreshSavedQuotesDropdown() {
  const sel = document.getElementById("savedQuotesSelect");
  if (!sel) return;

  const storedQuotes = JSON.parse(localStorage.getItem("SwanQuotes") || "{}");
  const keys = Object.keys(storedQuotes);
  const filter = (document.getElementById("quoteFilter")?.value || "").trim().toLowerCase();

  sel.innerHTML = \`<option value="">Saved Quotes‚Ä¶</option>\`;
  keys.sort((a,b) => a.localeCompare(b, undefined, {numeric:true, sensitivity:"base"}));

  keys.forEach(qNo => {
    const eng = storedQuotes[qNo]?.engineer || "Unknown";
    const label = \`\${qNo} ‚Äì \${eng}\`;
    if (filter && !label.toLowerCase().includes(filter)) return;

    const opt = document.createElement("option");
    opt.value = qNo;
    opt.textContent = label;
    sel.appendChild(opt);
  });
}

/* =========================
   CLEAR
   ========================= */
function clearSheet() {
  if (!confirm("Clear entire sheet?")) return;
  document.querySelector("#quoteTable tbody").innerHTML = "";
  document.querySelector("#labourTable tbody").innerHTML = "";
  document.getElementById("partsNet").textContent = "0.00";
  document.getElementById("totalMarkup").textContent = "0.00";
  document.getElementById("labourTotal").textContent = "0.00";
  document.getElementById("vatTotal").textContent = "0.00";
  document.getElementById("invoiceTotal").textContent = "0.00";

  lastSavedAt = "";
  document.getElementById("dashSaved").textContent = "‚Äî";
  onAnyChange();
  recalc();
}

/* =========================
   EXPORT QUOTE
   ========================= */
function exportQuoteExcel() {
  const wb = XLSX.utils.book_new();

  const engineer = getLoggedInEngineer();
  const quoteNumber = document.getElementById("quoteNumber").value || "";
  const status = document.getElementById("quoteStatus").value || "";
  const vatMode = document.getElementById("vatToggle").value || "";

  const metaRows = [
    ["Version", APP_VERSION],
    ["Quote Number", quoteNumber],
    ["Status", status],
    ["Engineer", engineer],
    ["VAT Mode", vatMode],
    ["Exported At", new Date().toISOString()],
    ["", ""]
  ];

  const partRows = [["Part Number","Item Name","Qty","Cost","Markup %","Keep Manual Markup","URL","Preset Markup","Net","Markup","Total"]];
  document.querySelectorAll("#quoteTable tbody tr").forEach(row => {
    partRows.push([
      row.querySelector(".partSearch")?.value || "",
      row.querySelector(".itemName")?.value || "",
      row.querySelector(".qty")?.value || "",
      row.querySelector(".cost")?.value || "",
      row.querySelector(".markup")?.value || "",
      row.querySelector(".keepMarkup")?.checked ? "YES" : "NO",
      row.dataset.url || "",
      row.dataset.presetMarkup || "",
      row.querySelector(".netCell")?.textContent || "0.00",
      row.querySelector(".markCell")?.textContent || "0.00",
      row.querySelector(".totalCell")?.textContent || "0.00"
    ]);
  });

  const labourRows = [["Labour Type","Hours","Rate","Total"]];
  document.querySelectorAll("#labourTable tbody tr").forEach(row => {
    labourRows.push([
      row.querySelector(".labType")?.value || "",
      row.querySelector(".hours")?.value || "",
      row.querySelector(".rate")?.value || "",
      row.querySelector(".labTotalCell")?.textContent || "0.00"
    ]);
  });

  const totalsRows = [
    ["Parts NET", document.getElementById("partsNet").textContent],
    ["Total Mark-Up", document.getElementById("totalMarkup").textContent],
    ["Labour Total", document.getElementById("labourTotal").textContent],
    ["VAT (20%)", document.getElementById("vatTotal").textContent],
    ["Invoice Total", document.getElementById("invoiceTotal").textContent]
  ];

  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(metaRows), "QuoteInfo");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(partRows), "Parts");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(labourRows), "Labour");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(totalsRows), "Totals");

  XLSX.writeFile(wb, "Swan_Quote_v17.xlsx");
}

/* =========================
   WORKEVER EXPORT/IMPORT
   ========================= */
function exportInventoryTemplate() {
  const wb = XLSX.utils.book_new();

  const header = [
    "Product code","Item name","Purchases unit price","Sales description","Sales unit price",
    "Sales account","Markup","Sales tax rate","Quantity on hand","Stock location",
    "Stock location description","Stock replenishment alert","Supplier","URL"
  ];

  const rows = [header];

  Object.keys(inventory).forEach(code => {
    const item = inventory[code] || {};
    const cost = toNumber(item.cost);
    const markup = toNumber(item.markup);
    const sale = (item.salePrice !== undefined && item.salePrice !== null && item.salePrice !== "")
      ? toNumber(item.salePrice)
      : (Number.isFinite(cost) && Number.isFinite(markup) ? round2(cost * (1 + markup/100)) : "");

    rows.push([
      code,
      item.name ?? "",
      (Number.isFinite(cost) ? cost : ""),
      item.salesDescription ?? "",
      (sale === "" ? "" : sale),
      item.salesAccount ?? "Sales",
      (Number.isFinite(markup) ? markup : ""),
      (item.taxRate ?? 20),
      (item.qtyOnHand ?? ""),
      (item.stockLocation ?? ""),
      (item.stockLocationDesc ?? ""),
      (item.replenishmentAlert ?? ""),
      (item.supplier ?? ""),
      (item.url ?? "")
    ]);
  });

  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "Inventory");
  XLSX.writeFile(wb, "Workever_Inventory_Export_v17.xlsx");
}

function importInventory(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type:'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    inventory = {};
    const H = {
      code: "Product code", name: "Item name", cost: "Purchases unit price",
      salesDesc: "Sales description", salesPrice: "Sales unit price", salesAccount: "Sales account",
      markup: "Markup", tax: "Sales tax rate", qty: "Quantity on hand",
      loc: "Stock location", locDesc: "Stock location description",
      repl: "Stock replenishment alert", supplier: "Supplier", url: "URL"
    };

    const getField = (row, fieldName) => {
      if (row[fieldName] !== undefined) return row[fieldName];
      const target = String(fieldName).toLowerCase().trim();
      const key = Object.keys(row).find(k => String(k).toLowerCase().trim() === target);
      return key ? row[key] : "";
    };

    let importedCount = 0;

    rows.forEach(r => {
      const codeRaw = String(getField(r, H.code)).trim();
      const name = String(getField(r, H.name)).trim();
      if (!codeRaw || !name) return;

      const norm = normalizeAndValidateCode(codeRaw);
      if (!norm.ok) return;
      const code = norm.code;

      const cost = toNumber(getField(r, H.cost));
      const markup = toNumber(getField(r, H.markup));
      const salePrice = toNumber(getField(r, H.salesPrice));
      const taxRate = toNumber(getField(r, H.tax));
      const qtyOnHand = toNumber(getField(r, H.qty));

      const salesDescription = String(getField(r, H.salesDesc)).trim();
      const salesAccount = String(getField(r, H.salesAccount)).trim();
      const stockLocation = String(getField(r, H.loc)).trim();
      const stockLocationDesc = String(getField(r, H.locDesc)).trim();
      const replenishmentAlert = String(getField(r, H.repl)).trim();
      const supplier = String(getField(r, H.supplier)).trim();
      const url = String(getField(r, H.url)).trim();

      if (!inventory[code]) {
        inventory[code] = {
          name,
          cost: Number.isFinite(cost) ? cost : 0,
          markup: Number.isFinite(markup) ? markup : 0,
          salePrice: Number.isFinite(salePrice) ? salePrice : "",
          taxRate: Number.isFinite(taxRate) && taxRate !== 0 ? taxRate : 20,
          qtyOnHand: Number.isFinite(qtyOnHand) ? qtyOnHand : "",
          stockLocation,
          stockLocationDesc,
          replenishmentAlert,
          salesAccount,
          salesDescription,
          supplier,
          url
        };
        importedCount++;
      } else {
        // should not happen due to reset, but keep safe
        inventory[code].name = name;
        importedCount++;
      }
    });

    saveInventoryToLocal();
    addAudit({ action:"IMPORT_WORKEVER", note:\`Imported \${importedCount} items\` });
    renderInventoryTable();
    renderAuditTable();

    alert("Inventory updated successfully! (Workever import)");
    event.target.value = "";
    recalc();
    onAnyChange();
  };
  reader.readAsArrayBuffer(file);
}

/* =========================
   HELPERS
   ========================= */
function toNumber(v) {
  if (v === null || v === undefined) return NaN;
  const s = String(v).replace(/¬£/g, '').replace(/,/g, '').trim();
  if (s === "") return NaN;
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function round2(n) { return Math.round((n + Number.EPSILON) * 100) / 100; }
function fmt(v){
  const n = toNumber(v);
  if (!Number.isFinite(n)) return (v === "" || v === null || v === undefined) ? "" : String(v);
  return n.toFixed(2);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\\"":"&quot;","'":"&#39;"
  }[m]));
}
function escapeAttr(s){ return String(s).replace(/"/g, "&quot;"); }
function formatIso(iso){
  try{
    const d = new Date(iso);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return \`\${yyyy}-\${mm}-\${dd} \${hh}:\${mi}\`;
  }catch(e){ return String(iso||""); }
}
<\/script>
</body>
</html>`;

function renderQuotes(){
  const wrap = document.createElement("div");

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h2>Quotes</h2>
    <div class="muted">Swan v17 Quote Builder (embedded). Works inside this app (no new tab).</div>
    <div style="margin-top:12px">
      <iframe id="quotesFrame"
        style="width:100%;height:80vh;border:1px solid rgba(255,255,255,.12);border-radius:14px;background:#000"
        sandbox="allow-scripts allow-forms allow-downloads allow-same-origin"
      ></iframe>
    </div>
  `;
  wrap.appendChild(card);

  const frame = card.querySelector("#quotesFrame");
  frame.srcdoc = SWAN_QUOTE_HTML_V17;

  // Safety: if a link inside the quote builder tries to open a popup/new tab, block it.
  // (The iframe sandbox also helps here.)
  return wrap;
}
const VAT_RATE = 0.20;
const JOB_STATUSES = ["Booked","In Progress","Completed","Invoiced","Paid"];
const INVOICE_STATUSES = ["Draft","Sent","Paid","Overdue"];

/* ===== SS Job ID system (sequential + sub-jobs) ===== */
const JOB_SEQ_KEY = "SwanJobSeq_SS";
const SUBJOB_SEQ_PREFIX = "SwanSubJobSeq_SS_";

function getNextTopLevelJobId() {
  initJobCountersFromState();
  let n = parseInt(localStorage.getItem(JOB_SEQ_KEY) || "100", 10);
  if (!Number.isFinite(n) || n < 100) n = 100;
  const jobId = `SS${n}`;
  localStorage.setItem(JOB_SEQ_KEY, String(n + 1));
  return jobId;
}
function getNextSubJobId(parentJobId) {
  if (!parentJobId || !/^SS\d+$/.test(parentJobId)) throw new Error("Parent job ID must look like SS107.");
  const key = SUBJOB_SEQ_PREFIX + parentJobId;
  let n = parseInt(localStorage.getItem(key) || "1", 10);
  if (!Number.isFinite(n) || n < 1) n = 1;
  const subId = `${parentJobId}-${n}`;
  localStorage.setItem(key, String(n + 1));
  return subId;
}
function initJobCountersFromState(){
  const jobs = state?.jobs || [];
  let maxTop = 99;
  for (const j of jobs){
    const id = String(j.id || "");
    const m = id.match(/^SS(\d+)$/);
    if (m){
      const n = parseInt(m[1], 10);
      if (Number.isFinite(n) && n > maxTop) maxTop = n;
    }
  }
  const stored = parseInt(localStorage.getItem(JOB_SEQ_KEY) || "100", 10);
  const suggestedNext = Math.max(100, maxTop + 1);
  if (!Number.isFinite(stored) || stored < suggestedNext) localStorage.setItem(JOB_SEQ_KEY, String(suggestedNext));

  const subMap = {};
  for (const j of jobs){
    const id = String(j.id || "");
    const sm = id.match(/^(SS\d+)-(\d+)$/);
    if (sm){
      const parent = sm[1];
      const n = parseInt(sm[2], 10);
      if (!Number.isFinite(n)) continue;
      subMap[parent] = Math.max(subMap[parent] || 0, n);
    }
  }
  for (const parent of Object.keys(subMap)){
    const key = SUBJOB_SEQ_PREFIX + parent;
    const cur = parseInt(localStorage.getItem(key) || "1", 10);
    const next = subMap[parent] + 1;
    if (!Number.isFinite(cur) || cur < next) localStorage.setItem(key, String(next));
  }
}

/* ===== Calendar state ===== */
let state = loadState() ?? seedDemo();
let route = { name:"dashboard", params:{} };
let calendarInstance = null;

function go(name, params={}){
  route = { name, params };
  highlightNav();
  render();
}

function highlightNav(){
  const map = {
    dashboard:"navDashboard",
    calendar:"navCalendar",
    jobs:"navJobs",
    clients:"navClients",
    client:"navClients",
    sites:"navSites",
    site:"navSites",
    job:"navJobs",
    invoices:"navInvoices",
    invoice:"navInvoices",
    quotes:"navQuotes",
    purchaseOrders:"navPO",
    timesheets:"navTimesheets",
    reminders:"navReminders",
    assets:"navAssets",
    contracts:"navContracts",
    documents:"navDocuments",
    settings:"navSettings"
  };
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  const id = map[route.name];
  if (id) document.getElementById(id)?.classList.add("active");
}

function render(){
  updatePills();
  const view = document.getElementById("view");
  view.innerHTML = "";
  const q = (document.getElementById("globalSearch").value || "").trim().toLowerCase();

  if (route.name === "dashboard") view.appendChild(renderDashboard(q));
  else if (route.name === "calendar") view.appendChild(renderCalendar(q));
  else if (route.name === "jobs") view.appendChild(renderJobsAll(q));
  else if (route.name === "clients") view.appendChild(renderClients(q));
  else if (route.name === "client") view.appendChild(renderClient(route.params.clientId, q));
  else if (route.name === "sites") view.appendChild(renderSitesAll(q));
  else if (route.name === "site") view.appendChild(renderSite(route.params.siteId, q));
  else if (route.name === "job") view.appendChild(renderJob(route.params.jobId));
  else if (route.name === "quotes") view.appendChild(renderQuotes());
  else if (route.name === "invoices") view.appendChild(renderInvoices(q));
  else if (route.name === "invoice") view.appendChild(renderInvoice(route.params.invoiceId));
  else if (route.name === "settings") view.appendChild(renderSettings());
  else view.appendChild(renderPlaceholder(route.name));
}

/* =========================
   PLACEHOLDERS (Workever-like menu items)
========================= */
function renderPlaceholder(name){
  const d = document.createElement("div");
  d.className = "card";
  d.innerHTML = `
    <h2>${esc(titleCase(name))} (coming soon)</h2>
    <div class="muted">This menu is here to match the layout you‚Äôre used to. We can build this section next.</div>
  `;
  return d;
}
function titleCase(s){
  return String(s||"").replace(/([A-Z])/g," $1").replace(/^./, m=>m.toUpperCase()).trim();
}

/* =========================
   DASHBOARD
========================= */
function renderDashboard(q){
  const el = document.createElement("div");

  const jobs = state.jobs.map(j=>decorateJob(j));
  const invoices = state.invoices.map(i=>decorateInvoice(i));

  const kpi = {
    openJobs: jobs.filter(j=>!["Paid"].includes(j.status)).length,
    booked: jobs.filter(j=>j.status==="Booked").length,
    completed: jobs.filter(j=>j.status==="Completed").length,
    overdue: invoices.filter(i=>i.status==="Overdue").length
  };

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h2>Dashboard</h2>
    <div class="muted">Quick overview of jobs + invoicing.</div>
    <div class="kpis">
      <div class="kpi"><div class="label">Open jobs</div><div class="value">${kpi.openJobs}</div></div>
      <div class="kpi"><div class="label">Booked</div><div class="value">${kpi.booked}</div></div>
      <div class="kpi"><div class="label">Completed</div><div class="value">${kpi.completed}</div></div>
      <div class="kpi"><div class="label">Overdue invoices</div><div class="value">${kpi.overdue}</div></div>
    </div>
  `;
  el.appendChild(card);

  const split = document.createElement("div");
  split.className = "split";

  const left = document.createElement("div");
  left.className = "card";
  left.innerHTML = `<h2>Upcoming Jobs</h2><div class="muted">Drag/drop in Scheduler to move bookings.</div>`;
  left.appendChild(renderJobsTable(jobs, q, { limit: 8 }));

  const right = document.createElement("div");
  right.className = "card";
  right.innerHTML = `<h2>Invoices</h2><div class="muted">Draft / Sent / Paid / Overdue.</div>`;
  right.appendChild(renderInvoicesTable(invoices, q, { limit: 8 }));

  split.appendChild(left);
  split.appendChild(right);
  el.appendChild(split);

  return el;
}

/* =========================
   JOBS (All jobs list)
========================= */
function renderJobsAll(q){
  const el = document.createElement("div");
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h2>Jobs</h2>
    <div class="muted">All jobs across all clients & sites.</div>
    <div class="toolbar">
      <button class="btn primary" onclick="openModal('addJob')">+ New Job</button>
      <button class="btn" onclick="go('calendar')">Open Scheduler</button>
    </div>
  `;
  const jobs = state.jobs.map(j=>decorateJob(j)).filter(j => matchAny(q, [j.id, j.title, j.clientName, j.siteName, j.engineer, j.status]));
  card.appendChild(renderJobsTable(jobs, "", { limit: null }));
  el.appendChild(card);
  return el;
}

/* =========================
   SITES (All sites list)
========================= */
function renderSitesAll(q){
  const el = document.createElement("div");
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h2>Sites</h2>
    <div class="muted">All sites across all clients.</div>
    <div class="toolbar">
      <button class="btn primary" onclick="openModal('addSite')">+ New Site</button>
    </div>
  `;

  const sites = state.sites
    .map(s=>{
      const c = state.clients.find(x=>x.id===s.clientId);
      return {...s, clientName: c?.name || "‚Äî"};
    })
    .filter(s => matchAny(q, [s.name, s.address, s.clientName, s.siteContact?.name, s.siteContact?.phone]));

  const table = document.createElement("table");
  table.innerHTML = `
    <thead><tr>
      <th>Site</th><th>Client</th><th>Address</th><th class="right">Actions</th>
    </tr></thead>
    <tbody>
      ${sites.map(s=>`
        <tr>
          <td><a href="#" onclick="go('site',{siteId:'${s.id}'}); return false;"><b>${esc(s.name)}</b></a></td>
          <td>${esc(s.clientName)}</td>
          <td class="small">${esc(s.address || "")}</td>
          <td class="right">
            <button class="btn" onclick="openModal('addJob','${s.id}')">+ Job</button>
            <button class="btn" onclick="openModal('editSite','${s.id}')">Edit</button>
          </td>
        </tr>
      `).join("")}
    </tbody>
  `;
  card.appendChild(table);
  el.appendChild(card);
  return el;
}

/* =========================
   CALENDAR (Month drag fix)
========================= */
function renderCalendar(q){
  const wrap = document.createElement("div");
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h2>Scheduler</h2>
    <div class="muted">
      Drag & drop jobs to reschedule the <b>Booked date/time</b>. Click an event to open the job.
      <div class="small" style="margin-top:6px;">
        Month view drag keeps the time consistent (no jumping to midnight).
      </div>
    </div>
    <div class="toolbar">
      <button class="btn primary" onclick="openModal('addJob')">+ New Job</button>
      <button class="btn" onclick="refreshCalendar()">Refresh</button>
    </div>
    <div id="calendar" style="margin-top:12px;"></div>
  `;
  wrap.appendChild(card);
  setTimeout(() => initCalendar(q), 0);
  return wrap;
}

function addDuration(dateObj, dur){
  const d = new Date(dateObj.getTime());
  if (!dur) return d;
  if (dur.years) d.setFullYear(d.getFullYear() + dur.years);
  if (dur.months) d.setMonth(d.getMonth() + dur.months);
  if (dur.days) d.setDate(d.getDate() + dur.days);
  if (dur.milliseconds) d.setTime(d.getTime() + dur.milliseconds);
  return d;
}

function initCalendar(q){
  const el = document.getElementById("calendar");
  if (!el) return;

  if (calendarInstance) { calendarInstance.destroy(); calendarInstance = null; }

  const events = state.jobs
    .map(j => decorateJob(j))
    .filter(j => {
      if (!q) return true;
      return matchAny(q, [j.title, j.clientName, j.siteName, j.engineer, j.status, j.id]);
    })
    .filter(j => !!j.scheduledStart)
    .map(j => {
      const start = new Date(j.scheduledStart);
      let end = j.scheduledEnd ? new Date(j.scheduledEnd) : null;
      if (!end || isNaN(end.getTime())) end = new Date(start.getTime() + 2*60*60*1000);
      return {
        id: j.id,
        title: `${j.id} ‚Äî ${j.title} (${j.engineer || "‚Äî"})`,
        start: start.toISOString(),
        end: end.toISOString(),
        allDay: false
      };
    });

  calendarInstance = new FullCalendar.Calendar(el, {
    initialView: "timeGridWeek",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek"
    },
    nowIndicator: true,
    editable: true,
    eventDurationEditable: true,
    eventStartEditable: true,
    dayMaxEvents: true,

    displayEventTime: true,
    eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: false },

    events,

    eventClick: (info) => { go("job", { jobId: info.event.id }); },

    eventDrop: (info) => {
      const jobId = info.event.id;
      const job = state.jobs.find(j => j.id === jobId);
      if (!job || !job.scheduledStart) return;

      const oldStart = new Date(job.scheduledStart);
      const oldEnd = job.scheduledEnd ? new Date(job.scheduledEnd) : null;

      const newStart = addDuration(oldStart, info.delta);
      let newEnd = null;

      if (oldEnd && !isNaN(oldEnd.getTime())) newEnd = addDuration(oldEnd, info.delta);
      else {
        const evEnd = info.event.end ? new Date(info.event.end) : null;
        newEnd = (evEnd && !isNaN(evEnd.getTime())) ? evEnd : new Date(newStart.getTime() + 2*60*60*1000);
      }

      job.scheduledStart = newStart.toISOString();
      job.scheduledEnd = newEnd ? newEnd.toISOString() : "";

      persist(false);
      refreshCalendar();
    },

    eventResize: (info) => {
      const jobId = info.event.id;
      const job = state.jobs.find(j => j.id === jobId);
      if (!job || !job.scheduledStart) return;

      const newEnd = info.event.end ? new Date(info.event.end) : null;
      if (newEnd && !isNaN(newEnd.getTime())) {
        job.scheduledEnd = newEnd.toISOString();
        persist(false);
        refreshCalendar();
      }
    }
  });

  calendarInstance.render();
}

function refreshCalendar(){
  if (route.name !== "calendar") return;
  const q = (document.getElementById("globalSearch").value || "").trim().toLowerCase();
  initCalendar(q);
}

/* =========================
   CLIENTS / SITES / JOB VIEW
========================= */
function renderClients(q){
  const el = document.createElement("div");

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h2>Contacts</h2>
    <div class="muted">Add clients, then add sites under each client, then create jobs.</div>
    <div class="toolbar">
      <button class="btn primary" onclick="openModal('addClient')">+ New Contact</button>
    </div>
  `;

  const rows = state.clients
    .map(c => ({
      ...c,
      sites: state.sites.filter(s=>s.clientId===c.id).length,
      jobs: state.jobs.filter(j=>{
        const s = state.sites.find(x=>x.id===j.siteId);
        return s?.clientId === c.id;
      }).length
    }))
    .filter(c => matchAny(q, [c.name, c.billing?.company, c.billing?.email, c.billing?.phone]));

  const table = document.createElement("table");
  table.innerHTML = `
    <thead><tr>
      <th>Contact</th><th>Sites</th><th>Jobs</th><th>Billing</th><th class="right">Actions</th>
    </tr></thead>
    <tbody>
      ${rows.map(c=>`
        <tr>
          <td>
            <a href="#" onclick="go('client',{clientId:'${c.id}'}); return false;"><b>${esc(c.name)}</b></a>
            <div class="small">${esc(c.billing?.company || "")}</div>
          </td>
          <td>${c.sites}</td>
          <td>${c.jobs}</td>
          <td class="small">
            ${esc(c.billing?.email || "")}<br>
            ${esc(c.billing?.phone || "")}
          </td>
          <td class="right">
            <button class="btn" onclick="openModal('editClient','${c.id}')">Edit</button>
            <button class="btn" onclick="deleteClient('${c.id}')">Delete</button>
          </td>
        </tr>
      `).join("")}
    </tbody>
  `;
  card.appendChild(table);

  el.appendChild(card);
  return el;
}

function renderClient(clientId, q){
  const client = state.clients.find(c=>c.id===clientId);
  if (!client) return missing("Client not found");

  const el = document.createElement("div");

  const head = document.createElement("div");
  head.className = "card";
  head.innerHTML = `
    <h2>${esc(client.name)}</h2>
    <div class="muted">Contact ‚Üí Sites ‚Üí Jobs. Billing details used for invoices.</div>
    <div class="toolbar">
      <button class="btn" onclick="go('clients')">‚Üê Back</button>
      <button class="btn primary" onclick="openModal('addSite','${client.id}')">+ Add Site</button>
      <button class="btn" onclick="openModal('addInvoice','${client.id}')">+ New Invoice</button>
      <button class="btn" onclick="openModal('editClient','${client.id}')">Edit</button>
    </div>
  `;
  el.appendChild(head);

  const split = document.createElement("div");
  split.className = "split";

  const left = document.createElement("div");
  left.className = "card";
  left.innerHTML = `<h2>Sites</h2><div class="muted">Each contact can have multiple sites.</div>`;
  const sites = state.sites
    .filter(s=>s.clientId===clientId)
    .filter(s => matchAny(q, [s.name, s.address, s.siteContact?.name, s.siteContact?.phone]));
  left.appendChild(renderSitesTable(sites));

  const right = document.createElement("div");
  right.className = "card";
  right.innerHTML = `<h2>Billing details</h2><div class="muted">Used automatically when invoicing jobs.</div>`;
  right.appendChild(renderBillingCard(client));

  split.appendChild(left);
  split.appendChild(right);
  el.appendChild(split);

  return el;
}

function renderSite(siteId, q){
  const site = state.sites.find(s=>s.id===siteId);
  if (!site) return missing("Site not found");
  const client = state.clients.find(c=>c.id===site.clientId);

  const el = document.createElement("div");
  const head = document.createElement("div");
  head.className = "card";
  head.innerHTML = `
    <h2>${esc(site.name)}</h2>
    <div class="muted">
      Contact: <a href="#" onclick="go('client',{clientId:'${site.clientId}'}); return false;">${esc(client?.name || "")}</a>
    </div>
    <div class="toolbar">
      <button class="btn" onclick="go('client',{clientId:'${site.clientId}'})">‚Üê Back</button>
      <button class="btn primary" onclick="openModal('addJob','${site.id}')">+ Add Job</button>
      <button class="btn" onclick="openModal('editSite','${site.id}')">Edit</button>
    </div>
  `;
  el.appendChild(head);

  const split = document.createElement("div");
  split.className = "split";

  const left = document.createElement("div");
  left.className = "card";
  left.innerHTML = `<h2>Jobs</h2><div class="muted">Booked ‚Üí In Progress ‚Üí Completed ‚Üí Invoiced ‚Üí Paid</div>`;

  const jobs = state.jobs
    .filter(j=>j.siteId===siteId)
    .map(j=>decorateJob(j))
    .filter(j => matchAny(q, [j.title, j.status, j.engineer, j.siteName, j.clientName, j.id]));
  left.appendChild(renderJobsTable(jobs, "", { showClient:false }));

  const right = document.createElement("div");
  right.className = "card";
  right.innerHTML = `<h2>Site details</h2>`;
  right.appendChild(renderSiteCard(site));

  split.appendChild(left);
  split.appendChild(right);
  el.appendChild(split);

  return el;
}

function renderJob(jobId){
  const job = state.jobs.find(j=>j.id===jobId);
  if (!job) return missing("Job not found");
  const dj = decorateJob(job);

  const el = document.createElement("div");

  const head = document.createElement("div");
  head.className = "card";
  head.innerHTML = `
    <h2>${esc(dj.id)} ‚Äî ${esc(dj.title)}</h2>
    <div class="muted">
      ${statusBadge(dj.status)}
      &nbsp; ‚Ä¢ &nbsp; Contact: <a href="#" onclick="go('client',{clientId:'${dj.clientId}'}); return false;">${esc(dj.clientName)}</a>
      &nbsp; ‚Ä¢ &nbsp; Site: <a href="#" onclick="go('site',{siteId:'${dj.siteId}'}); return false;">${esc(dj.siteName)}</a>
    </div>

    <div class="toolbar">
      <button class="btn" onclick="go('site',{siteId:'${dj.siteId}'})">‚Üê Back</button>
      <button class="btn" onclick="openModal('editJob','${dj.id}')">Edit</button>
      <button class="btn" onclick="openModal('jobCosting','${dj.id}')">Parts/Labour</button>
      <button class="btn" onclick="openModal('addSubJob','${dj.id}')">+ Sub-job</button>
      <button class="btn primary" onclick="openModal('addInvoice','${dj.clientId}', '${dj.id}')">Invoice this job</button>
      <button class="btn" onclick="deleteJob('${dj.id}')">Delete</button>
    </div>
  `;
  el.appendChild(head);

  const subs = state.jobs
    .filter(j => String(j.parentJobId||"") === dj.id)
    .map(j => decorateJob(j))
    .sort((a,b)=>a.id.localeCompare(b.id));

  const subCard = document.createElement("div");
  subCard.className = "card";
  subCard.style.marginTop = "14px";
  subCard.innerHTML = `
    <h2>Sub-jobs</h2>
    <div class="muted">Sub-jobs under <span class="mono">${esc(dj.id)}</span> (e.g. <span class="mono">${esc(dj.id)}-1</span>).</div>
    <div class="toolbar">
      <button class="btn primary" onclick="openModal('addSubJob','${dj.id}')">+ Create sub-job</button>
    </div>
  `;
  if (subs.length){
    subCard.appendChild(renderJobsTable(subs, "", { showClient:false, showSite:false, limit:null }));
  } else {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.style.marginTop = "10px";
    empty.textContent = "No sub-jobs yet.";
    subCard.appendChild(empty);
  }
  el.appendChild(subCard);

  const split = document.createElement("div");
  split.className = "split";

  const left = document.createElement("div");
  left.className = "card";
  left.innerHTML = `<h2>Job info</h2>`;
  left.appendChild(jobInfoCard(dj));

  const right = document.createElement("div");
  right.className = "card";
  right.innerHTML = `<h2>Cost summary</h2><div class="muted">VAT 20% applied to parts + labour</div>`;
  right.appendChild(jobCostSummary(dj));

  split.appendChild(left);
  split.appendChild(right);
  el.appendChild(split);

  return el;
}

/* =========================
   INVOICES / SETTINGS (unchanged)
========================= */
function renderInvoices(q){
  const el = document.createElement("div");

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h2>Invoices</h2>
    <div class="muted">Create invoices from one or multiple jobs (billed to client billing details).</div>
    <div class="toolbar">
      <button class="btn primary" onclick="openModal('addInvoice')">+ New Invoice</button>
    </div>
  `;

  const invoices = state.invoices.map(i=>decorateInvoice(i)).filter(i=>{
    return matchAny(q, [i.invoiceNo, i.clientName, i.status]);
  });

  card.appendChild(renderInvoicesTable(invoices, "", { showActions:true }));
  el.appendChild(card);
  return el;
}

function renderInvoice(invoiceId){
  const inv = state.invoices.find(i=>i.id===invoiceId);
  if (!inv) return missing("Invoice not found");
  const di = decorateInvoice(inv);

  const el = document.createElement("div");
  const head = document.createElement("div");
  head.className = "card";
  head.innerHTML = `
    <h2>Invoice ${esc(di.invoiceNo)}</h2>
    <div class="muted">
      ${invoiceStatusBadge(di.status)}
      &nbsp; ‚Ä¢ &nbsp; Contact: <a href="#" onclick="go('client',{clientId:'${di.clientId}'}); return false;">${esc(di.clientName)}</a>
      &nbsp; ‚Ä¢ &nbsp; Due: <span class="mono">${esc(di.dueDate || "‚Äî")}</span>
    </div>
    <div class="toolbar">
      <button class="btn" onclick="go('invoices')">‚Üê Back</button>
      <button class="btn" onclick="openModal('editInvoice','${di.id}')">Edit</button>
      <button class="btn" onclick="deleteInvoice('${di.id}')">Delete</button>
    </div>
  `;
  el.appendChild(head);

  const split = document.createElement("div");
  split.className = "split";

  const left = document.createElement("div");
  left.className = "card";
  left.innerHTML = `<h2>Invoice jobs</h2><div class="muted">Multiple jobs per invoice supported.</div>`;
  left.appendChild(renderInvoiceJobs(di));

  const right = document.createElement("div");
  right.className = "card";
  right.innerHTML = `<h2>Totals</h2><div class="muted">Parts + Labour + VAT 20%</div>`;
  right.appendChild(renderInvoiceTotals(di));

  split.appendChild(left);
  split.appendChild(right);
  el.appendChild(split);

  return el;
}

function renderSettings(){
  const el = document.createElement("div");
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h2>Settings (prototype)</h2>
    <div class="muted">In the live system these will be admin settings.</div>
    <div class="form">
      <div class="field">
        <label>Default VAT rate</label>
        <input value="20%" disabled />
      </div>
      <div class="field">
        <label>Job statuses</label>
        <input value="${JOB_STATUSES.join(" ‚Üí ")}" disabled />
      </div>
      <div class="field span2">
        <label>Notes</label>
        <textarea disabled>Sidebar now uses grouped headings like Workever. Calendar month drag preserves time.</textarea>
      </div>
    </div>
  `;
  el.appendChild(card);
  return el;
}

/* =========================
   TABLE HELPERS
========================= */
function renderSitesTable(sites){
  const table = document.createElement("table");
  table.innerHTML = `
    <thead><tr>
      <th>Site</th><th>Address</th><th>Contact</th><th class="right">Actions</th>
    </tr></thead>
    <tbody>
      ${sites.map(s=>`
        <tr>
          <td>
            <a href="#" onclick="go('site',{siteId:'${s.id}'}); return false;"><b>${esc(s.name)}</b></a>
            <div class="small">${esc(s.accessNotes || "")}</div>
          </td>
          <td class="small">${esc(s.address || "")}</td>
          <td class="small">${esc(s.siteContact?.name || "")}<br>${esc(s.siteContact?.phone || "")}</td>
          <td class="right">
            <button class="btn" onclick="openModal('addJob','${s.id}')">+ Job</button>
            <button class="btn" onclick="openModal('editSite','${s.id}')">Edit</button>
          </td>
        </tr>
      `).join("")}
    </tbody>
  `;
  return table;
}

function renderJobsTable(jobs, q, opts={}){
  const { limit=null, showClient=true, showSite=true } = opts;

  let rows = jobs;
  if (q) rows = rows.filter(j => matchAny(q, [j.title, j.clientName, j.siteName, j.status, j.engineer, j.id]));
  if (limit) rows = rows.slice(0, limit);

  const table = document.createElement("table");
  table.innerHTML = `
    <thead><tr>
      <th>Job</th>
      ${showClient ? "<th>Contact</th>" : ""}
      ${showSite ? "<th>Site</th>" : ""}
      <th>Status</th>
      <th>Engineer</th>
      <th>Booked</th>
      <th>Actual</th>
      <th class="right">Total ex VAT</th>
      <th class="right">Actions</th>
    </tr></thead>
    <tbody>
      ${rows.map(j=>`
        <tr>
          <td>
            <a href="#" onclick="go('job',{jobId:'${j.id}'}); return false;"><b>${esc(j.id)} ‚Äî ${esc(j.title)}</b></a>
            ${j.parentJobId ? `<div class="small">Parent: <span class="mono">${esc(j.parentJobId)}</span></div>` : `<div class="small">Job ID: <span class="mono">${esc(j.id)}</span></div>`}
          </td>
          ${showClient ? `<td>${esc(j.clientName)}</td>` : ""}
          ${showSite ? `<td>${esc(j.siteName)}</td>` : ""}
          <td>${statusBadge(j.status)}</td>
          <td>${esc(j.engineer || "‚Äî")}</td>
          <td class="small">${formatDT(j.scheduledStart)}${j.scheduledEnd ? " ‚Üí " + formatDT(j.scheduledEnd) : ""}</td>
          <td class="small">${formatDT(j.actualStart)}${j.actualEnd ? " ‚Üí " + formatDT(j.actualEnd) : ""}</td>
          <td class="right">¬£${money(j.totalExVat)}</td>
          <td class="right">
            <button class="btn" onclick="openModal('editJob','${j.id}')">Edit</button>
            <button class="btn" onclick="openModal('jobCosting','${j.id}')">Parts/Labour</button>
          </td>
        </tr>
      `).join("")}
    </tbody>
  `;
  return table;
}

function renderInvoicesTable(invoices, q, opts={}){
  const { limit=null, showActions=true } = opts;
  let rows = invoices;
  if (q) rows = rows.filter(i => matchAny(q, [i.invoiceNo, i.clientName, i.status, i.id]));
  if (limit) rows = rows.slice(0, limit);

  const table = document.createElement("table");
  table.innerHTML = `
    <thead><tr>
      <th>Invoice</th><th>Contact</th><th>Status</th><th>Jobs</th><th class="right">Total inc VAT</th>${showActions ? "<th class='right'>Actions</th>" : ""}
    </tr></thead>
    <tbody>
      ${rows.map(i=>`
        <tr>
          <td>
            <a href="#" onclick="go('invoice',{invoiceId:'${i.id}'}); return false;"><b>${esc(i.invoiceNo)}</b></a>
            <div class="small">Due: <span class="mono">${esc(i.dueDate || "‚Äî")}</span></div>
          </td>
          <td>${esc(i.clientName)}</td>
          <td>${invoiceStatusBadge(i.status)}</td>
          <td>${(i.jobIds || []).length}</td>
          <td class="right">¬£${money(i.totalIncVat)}</td>
          ${showActions ? `
            <td class="right">
              <button class="btn" onclick="openModal('editInvoice','${i.id}')">Edit</button>
            </td>
          ` : ""}
        </tr>
      `).join("")}
    </tbody>
  `;
  return table;
}

/* =========================
   CARDS
========================= */
function renderBillingCard(client){
  const b = client.billing || {};
  const div = document.createElement("div");
  div.className = "card";
  div.style.boxShadow = "none";
  div.style.border = "1px solid var(--line2)";
  div.style.background = "var(--panel2)";
  div.innerHTML = `
    <div><b>${esc(b.company || client.name)}</b></div>
    <div class="small">${esc(b.billingAddress || "‚Äî")}</div>
    <div style="margin-top:8px" class="small">
      Email: ${esc(b.email || "‚Äî")}<br>
      Phone: ${esc(b.phone || "‚Äî")}<br>
      VAT No: ${esc(b.vatNo || "‚Äî")}
    </div>
  `;
  return div;
}

function renderSiteCard(site){
  const d = document.createElement("div");
  d.innerHTML = `
    <div class="muted small">Address</div>
    <div style="margin-top:4px">${esc(site.address || "‚Äî")}</div>
    <div style="margin-top:10px" class="muted small">Access notes</div>
    <div style="margin-top:4px">${esc(site.accessNotes || "‚Äî")}</div>
    <div style="margin-top:10px" class="muted small">Site contact</div>
    <div style="margin-top:4px">${esc(site.siteContact?.name || "‚Äî")} ‚Äî ${esc(site.siteContact?.phone || "")}</div>
  `;
  return d;
}

function jobInfoCard(j){
  const d = document.createElement("div");
  d.innerHTML = `
    <div class="form">
      <div class="field">
        <label>Status</label>
        <select onchange="updateJobField('${j.id}','status',this.value)">
          ${JOB_STATUSES.map(s=>`<option ${s===j.status?"selected":""}>${s}</option>`).join("")}
        </select>
      </div>
      <div class="field">
        <label>Engineer</label>
        <select onchange="updateJobField('${j.id}','engineer',this.value)">
          ${["Lewis Winters","Luke Scott"].map(e=>`<option ${e===j.engineer?"selected":""}>${e}</option>`).join("")}
        </select>
      </div>

      <div class="field">
        <label>Booked start (date/time)</label>
        <input type="datetime-local" value="${toLocalDT(j.scheduledStart)}" onchange="updateJobDT('${j.id}','scheduledStart',this.value)">
      </div>
      <div class="field">
        <label>Booked end (optional)</label>
        <input type="datetime-local" value="${toLocalDT(j.scheduledEnd)}" onchange="updateJobDT('${j.id}','scheduledEnd',this.value)">
      </div>

      <div class="field">
        <label>Actual start (engineer)</label>
        <input type="datetime-local" value="${toLocalDT(j.actualStart)}" onchange="updateJobDT('${j.id}','actualStart',this.value)">
      </div>
      <div class="field">
        <label>Actual end (engineer)</label>
        <input type="datetime-local" value="${toLocalDT(j.actualEnd)}" onchange="updateJobDT('${j.id}','actualEnd',this.value)">
      </div>

      <div class="field span2">
        <label>Notes</label>
        <textarea oninput="updateJobField('${j.id}','notes',this.value)">${esc(j.notes || "")}</textarea>
      </div>
    </div>
  `;
  return d;
}

function jobCostSummary(j){
  const d = document.createElement("div");
  const parts = num(j.partsNet);
  const labour = num(j.labourNet);
  const ex = parts + labour;
  const vat = ex * VAT_RATE;
  const inc = ex + vat;

  d.innerHTML = `
    <div class="kpis" style="grid-template-columns:repeat(2,minmax(0,1fr));">
      <div class="kpi"><div class="label">Parts ex VAT</div><div class="value">¬£${money(parts)}</div></div>
      <div class="kpi"><div class="label">Labour ex VAT</div><div class="value">¬£${money(labour)}</div></div>
      <div class="kpi"><div class="label">VAT (20%)</div><div class="value">¬£${money(vat)}</div></div>
      <div class="kpi"><div class="label">Total inc VAT</div><div class="value">¬£${money(inc)}</div></div>
    </div>
    ${(j.partsUsed && j.partsUsed.length) ? `
    <div style="margin-top:10px; border:1px solid #222; border-radius:10px; overflow:hidden;">
      <div style="padding:8px 10px; background:#0f0f0f; color:#bbb; font-size:12px; border-bottom:1px solid #222;">Parts on this job</div>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:6px 10px; border-bottom:1px solid #222;">Code</th>
            <th style="text-align:left; padding:6px 10px; border-bottom:1px solid #222;">Item</th>
            <th style="text-align:right; padding:6px 10px; border-bottom:1px solid #222;">Qty</th>
            <th style="text-align:left; padding:6px 10px; border-bottom:1px solid #222;">Location</th>
          </tr>
        </thead>
        <tbody>
          ${j.partsUsed.map(p=>`
            <tr>
              <td style="padding:6px 10px; border-bottom:1px solid #1b1b1b;">${esc(p.code||"")}</td>
              <td style="padding:6px 10px; border-bottom:1px solid #1b1b1b;">${esc(p.name||"")}</td>
              <td style="padding:6px 10px; border-bottom:1px solid #1b1b1b; text-align:right;">${num(p.qty)}</td>
              <td style="padding:6px 10px; border-bottom:1px solid #1b1b1b;">${esc(p.location||"")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
    ` : ``}
    <div class="toolbar">
      <button class="btn primary" onclick="openModal('jobCosting','${j.id}')">Edit parts/labour</button>
    </div>
  `;
  return d;
}

function renderInvoiceJobs(inv){
  const container = document.createElement("div");
  const jobs = (inv.jobIds || []).map(id => state.jobs.find(j=>j.id===id)).filter(Boolean).map(decorateJob);
  container.appendChild(renderJobsTable(jobs, "", { showClient:false, showSite:true }));
  return container;
}

function renderInvoiceTotals(inv){
  const jobs = (inv.jobIds || []).map(id => state.jobs.find(j=>j.id===id)).filter(Boolean);
  const totals = sumJobs(jobs);

  const d = document.createElement("div");
  d.innerHTML = `
    <div class="kpis" style="grid-template-columns:repeat(2,minmax(0,1fr));">
      <div class="kpi"><div class="label">Subtotal ex VAT</div><div class="value">¬£${money(totals.exVat)}</div></div>
      <div class="kpi"><div class="label">VAT (20%)</div><div class="value">¬£${money(totals.vat)}</div></div>
      <div class="kpi"><div class="label">Total inc VAT</div><div class="value">¬£${money(totals.incVat)}</div></div>
      <div class="kpi"><div class="label">Jobs on invoice</div><div class="value">${(inv.jobIds||[]).length}</div></div>
    </div>
  `;
  return d;
}

/* =========================
   MODALS
========================= */
function openModal(type, refId=null, jobId=null){
  const back = document.getElementById("modalBackdrop");
  const title = document.getElementById("modalTitle");
  const body = document.getElementById("modalBody");
  body.innerHTML = "";

  if (type === "addClient"){ title.textContent = "New Contact"; body.appendChild(clientForm()); }
  if (type === "editClient"){ title.textContent = "Edit Contact"; body.appendChild(clientForm(refId)); }

  if (type === "addSite"){ title.textContent = "New Site"; body.appendChild(siteForm(refId)); }
  if (type === "editSite"){ title.textContent = "Edit Site"; body.appendChild(siteForm(null, refId)); }

  if (type === "addJob"){ title.textContent = "New Job"; body.appendChild(jobForm(refId)); }
  if (type === "editJob"){ title.textContent = "Edit Job"; body.appendChild(jobForm(null, refId)); }

  if (type === "addSubJob"){ title.textContent = "New Sub-job"; body.appendChild(subJobForm(refId)); }

  if (type === "jobCosting"){ title.textContent = "Job Costing (Parts / Labour)"; body.appendChild(jobCostingForm(refId)); }

  if (type === "addInvoice"){ title.textContent = "New Invoice"; body.appendChild(invoiceForm(refId, jobId)); }
  if (type === "editInvoice"){ title.textContent = "Edit Invoice"; body.appendChild(invoiceForm(null, null, refId)); }

  back.style.display = "flex";
}
function closeModal(){ document.getElementById("modalBackdrop").style.display = "none"; }

/* =========================
   FORMS
========================= */
function clientForm(clientId=null){
  const existing = clientId ? state.clients.find(c=>c.id===clientId) : null;
  const div = document.createElement("div");
  div.innerHTML = `
    <div class="form">
      <div class="field span2">
        <label>Contact name</label>
        <input id="c_name" value="${esc(existing?.name||"")}" placeholder="e.g. John Smith / Company Ltd">
      </div>

      <div class="field">
        <label>Billing company</label>
        <input id="c_company" value="${esc(existing?.billing?.company||"")}" placeholder="Company name (if different)">
      </div>
      <div class="field">
        <label>VAT number</label>
        <input id="c_vat" value="${esc(existing?.billing?.vatNo||"")}" placeholder="GB...">
      </div>

      <div class="field span2">
        <label>Billing address</label>
        <input id="c_addr" value="${esc(existing?.billing?.billingAddress||"")}" placeholder="Full billing address">
      </div>

      <div class="field">
        <label>Email</label>
        <input id="c_email" value="${esc(existing?.billing?.email||"")}" placeholder="accounts@...">
      </div>
      <div class="field">
        <label>Phone</label>
        <input id="c_phone" value="${esc(existing?.billing?.phone||"")}" placeholder="07...">
      </div>

      <div class="field span2">
        <label>Notes</label>
        <textarea id="c_notes" placeholder="Anything helpful‚Ä¶">${esc(existing?.notes||"")}</textarea>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" onclick="${clientId ? `saveClient('${clientId}')` : "saveClient()"}">${clientId?"Save changes":"Create contact"}</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  `;
  return div;
}

function siteForm(clientId=null, siteId=null){
  const existing = siteId ? state.sites.find(s=>s.id===siteId) : null;
  const selectedClientId = clientId || existing?.clientId || state.clients[0]?.id || "";

  const div = document.createElement("div");
  div.innerHTML = `
    <div class="form">
      <div class="field span2">
        <label>Contact</label>
        <select id="s_client">
          ${state.clients.map(c=>`<option value="${c.id}" ${c.id===selectedClientId?"selected":""}>${esc(c.name)}</option>`).join("")}
        </select>
      </div>

      <div class="field span2">
        <label>Site name</label>
        <input id="s_name" value="${esc(existing?.name||"")}" placeholder="e.g. Main house / Factory gate / Site A">
      </div>

      <div class="field span2">
        <label>Address</label>
        <input id="s_addr" value="${esc(existing?.address||"")}" placeholder="Full site address">
      </div>

      <div class="field">
        <label>Site contact name</label>
        <input id="s_contact" value="${esc(existing?.siteContact?.name||"")}" placeholder="Name">
      </div>
      <div class="field">
        <label>Site contact phone</label>
        <input id="s_phone" value="${esc(existing?.siteContact?.phone||"")}" placeholder="Phone">
      </div>

      <div class="field span2">
        <label>Access notes</label>
        <input id="s_access" value="${esc(existing?.accessNotes||"")}" placeholder="Gate code, key safe, parking etc‚Ä¶">
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" onclick="${siteId ? `saveSite('${siteId}')` : "saveSite()"}">${siteId?"Save changes":"Create site"}</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  `;
  return div;
}

function jobForm(siteId=null, jobId=null){
  const existing = jobId ? state.jobs.find(j=>j.id===jobId) : null;
  const selectedSiteId = siteId || existing?.siteId || state.sites[0]?.id || "";
  const engineer = existing?.engineer || document.getElementById("engineerSelect").value;

  const div = document.createElement("div");
  div.innerHTML = `
    <div class="form">
      <div class="field span2">
        <label>Site</label>
        <select id="j_site">
          ${state.sites.map(s=>{
            const c = state.clients.find(x=>x.id===s.clientId);
            return `<option value="${s.id}" ${s.id===selectedSiteId?"selected":""}>${esc((c?.name||"") + " ‚Äî " + s.name)}</option>`;
          }).join("")}
        </select>
      </div>

      <div class="field span2">
        <label>Job title</label>
        <input id="j_title" value="${esc(existing?.title||"")}" placeholder="e.g. Gate service / Intercom install / Fault find">
      </div>

      <div class="field">
        <label>Status</label>
        <select id="j_status">
          ${JOB_STATUSES.map(s=>`<option ${s===(existing?.status||"Booked")?"selected":""}>${s}</option>`).join("")}
        </select>
      </div>

      <div class="field">
        <label>Engineer</label>
        <select id="j_engineer">
          ${["Lewis Winters","Luke Scott"].map(e=>`<option ${e===engineer?"selected":""}>${e}</option>`).join("")}
        </select>
      </div>

      <div class="field">
        <label>Booked start (date/time)</label>
        <input id="j_sched_start" type="datetime-local" value="${toLocalDT(existing?.scheduledStart)}">
      </div>
      <div class="field">
        <label>Booked end (optional)</label>
        <input id="j_sched_end" type="datetime-local" value="${toLocalDT(existing?.scheduledEnd)}">
      </div>

      <div class="field">
        <label>Actual start (optional)</label>
        <input id="j_actual_start" type="datetime-local" value="${toLocalDT(existing?.actualStart)}">
      </div>
      <div class="field">
        <label>Actual end (optional)</label>
        <input id="j_actual_end" type="datetime-local" value="${toLocalDT(existing?.actualEnd)}">
      </div>

      <div class="field span2">
        <label>Notes</label>
        <textarea id="j_notes" placeholder="Job notes‚Ä¶">${esc(existing?.notes||"")}</textarea>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" onclick="${jobId ? `saveJob('${jobId}')` : "saveJob()"}">${jobId?"Save changes":"Create job"}</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  `;
  return div;
}

function subJobForm(parentJobId){
  const parent = state.jobs.find(j => j.id === parentJobId);
  if (!parent) return missing("Parent job not found");

  const parentEngineer = parent.engineer || document.getElementById("engineerSelect").value;

  const div = document.createElement("div");
  div.innerHTML = `
    <div class="muted">Parent Job: <b class="mono">${esc(parentJobId)}</b></div>

    <div class="form" style="margin-top:10px;">
      <div class="field span2">
        <label>Sub-job title</label>
        <input id="sj_title" placeholder="e.g. Return visit / Extra remote / Additional wiring">
      </div>

      <div class="field">
        <label>Status</label>
        <select id="sj_status">
          ${JOB_STATUSES.map(s=>`<option ${s==="Booked"?"selected":""}>${s}</option>`).join("")}
        </select>
      </div>

      <div class="field">
        <label>Engineer</label>
        <select id="sj_engineer">
          ${["Lewis Winters","Luke Scott"].map(e=>`<option ${e===parentEngineer?"selected":""}>${e}</option>`).join("")}
        </select>
      </div>

      <div class="field">
        <label>Booked start (date/time)</label>
        <input id="sj_sched_start" type="datetime-local" value="">
      </div>
      <div class="field">
        <label>Booked end (optional)</label>
        <input id="sj_sched_end" type="datetime-local" value="">
      </div>

      <div class="field span2">
        <label>Notes</label>
        <textarea id="sj_notes" placeholder="Sub-job notes‚Ä¶"></textarea>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" onclick="createSubJob('${esc(parentJobId)}')">Create sub-job</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  `;
  return div;
}

function createSubJob(parentJobId){
  const parent = state.jobs.find(j => j.id === parentJobId);
  if (!parent) return alert("Parent job not found.");

  const title = (document.getElementById("sj_title")?.value || "").trim();
  if (!title) return alert("Sub-job title is required.");

  let newId = "";
  try { newId = getNextSubJobId(parentJobId); }
  catch(e){ return alert(e.message); }

  const data = {
    siteId: parent.siteId,
    title,
    status: document.getElementById("sj_status")?.value || "Booked",
    engineer: document.getElementById("sj_engineer")?.value || parent.engineer,
    notes: (document.getElementById("sj_notes")?.value || "").trim(),
    partsNet: 0,
    labourNet: 0,
    vatRate: VAT_RATE,

    scheduledStart: fromLocalDT(document.getElementById("sj_sched_start")?.value || ""),
    scheduledEnd: fromLocalDT(document.getElementById("sj_sched_end")?.value || ""),
    actualStart: "",
    actualEnd: "",

    parentJobId: parentJobId
  };

  state.jobs.push({ id: newId, ...data });
  persist();
  closeModal();
  go("job", { jobId: newId });
}

function jobCostingForm(jobId){
  const job = state.jobs.find(j=>j.id===jobId);
  if (!job) return missing("Job not found");
  job.partsUsed = job.partsUsed || [];
  job.stockDepleted = job.stockDepleted || false;

  const div = document.createElement("div");
  div.innerHTML = `
    <div class="muted">Simple costing (we‚Äôll plug in your full parts/labour grid later).</div>

    <div class="form" style="margin-top:12px;">
      <div class="field">
        <label>Parts total (ex VAT)</label>
        <input id="jc_parts" type="number" step="0.01" value="${num(job.partsNet)}">
      </div>
      <div class="field">
        <label>Labour total (ex VAT)</label>
        <input id="jc_labour" type="number" step="0.01" value="${num(job.labourNet)}">
      </div>
      <div class="field span2">
        <label>Notes (costing)</label>
        <textarea id="jc_notes" placeholder="Optional‚Ä¶">${esc(job.costNotes||"")}</textarea>
      </div>
    </div>

    <div class="jp-wrap">
      <label>Parts used (pull from Quotes inventory)</label>
      <div class="jp-help">Search by product code or item name. Pick a location, set quantity, then add to this job.</div>

      <div class="jp-searchRow">
        <div class="field">
          <label>Product code / item name</label>
          <input id="jp_search" placeholder="Type SWA101 or 'remote'..." autocomplete="off" oninput="jpRenderSuggestions('${jobId}')">
          <div id="jp_suggestions" class="jp-suggestions" style="display:none;"></div>
        </div>

        <div class="field" style="max-width:140px;">
          <label>Qty</label>
          <input id="jp_qty" type="number" min="1" step="1" value="1">
        </div>

        <div class="field" style="min-width:220px; max-width:260px;">
          <label>Deplete from (location)</label>
          <select id="jp_location">
            <option value="">Select location</option>
          </select>
        </div>

        <div class="field" style="max-width:180px;">
          <label>On hand</label>
          <input id="jp_onhand" type="text" value="‚Äî" disabled>
        </div>

        <div class="field" style="max-width:180px;">
          <label>&nbsp;</label>
          <button class="btn" onclick="jpAddSelectedToJob('${jobId}')">Add part</button>
        </div>

        <div class="jp-picked">
          <span class="pill">Selected: <b id="jp_selectedLabel">None</b></span>
        </div>
      </div>

      <table class="table jp-table" style="margin-top:12px;">
        <thead>
          <tr>
            <th>Code</th><th>Item</th><th class="right">Qty</th><th class="right">Cost</th>
            <th class="right">Markup %</th><th class="right">Tax %</th><th>Location</th>
            <th class="right">Line total (ex VAT)</th><th></th>
          </tr>
        </thead>
        <tbody>
          ${job.partsUsed.map((p,i)=>`
            <tr>
              <td>${esc(p.code)}</td>
              <td>${esc(p.name)}</td>
              <td class="right"><input style="max-width:90px;" type="number" min="1" value="${num(p.qty)}" onchange="jpUpdatePart('${jobId}',${i},'qty',this.value)"></td>
              <td class="right"><input style="max-width:110px;" type="number" step="0.01" value="${num(p.cost)}" onchange="jpUpdatePart('${jobId}',${i},'cost',this.value)"></td>
              <td class="right"><input style="max-width:110px;" type="number" step="0.01" value="${num(p.markup)}" onchange="jpUpdatePart('${jobId}',${i},'markup',this.value)"></td>
              <td class="right"><input style="max-width:90px;" type="number" step="0.01" value="${num(p.tax)}" onchange="jpUpdatePart('${jobId}',${i},'tax',this.value)"></td>
              <td>${esc(p.location||"")}</td>
              <td class="right">¬£${num(jpLineTotal(p)).toFixed(2)}</td>
              <td><button class="btn" onclick="jpRemovePart('${jobId}',${i})">Del</button></td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <div class="toolbar" style="margin-top:10px;">
        <button class="btn" onclick="jpRecalcJobPartsNet('${jobId}')">Recalc parts total</button>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" onclick="saveJobCosting('${jobId}')">Save costing</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  `;
  // init inventory cache lazily
  setTimeout(()=>{ jpInitInventory(); jpClearSelection(); }, 0);
  return div;
}

function invoiceForm(clientId=null, jobId=null, invoiceId=null){
  const editing = !!invoiceId;
  const inv = editing ? state.invoices.find(i=>i.id===invoiceId) : null;

  const selectedClientId = (inv?.clientId) || clientId || state.clients[0]?.id || "";
  const suggestedNo = "INV-" + String(Date.now()).slice(-6);
  const invoiceNo = inv?.invoiceNo || suggestedNo;

  let presetJobIds = [];
  if (inv?.jobIds?.length) presetJobIds = inv.jobIds.slice();
  else if (jobId) presetJobIds = [jobId];

  const div = document.createElement("div");
  div.innerHTML = `
    <div class="form" style="margin-top:10px;">
      <div class="field span2">
        <label>Contact</label>
        <select id="i_client">
          ${state.clients.map(c=>`<option value="${c.id}" ${c.id===selectedClientId?"selected":""}>${esc(c.name)}</option>`).join("")}
        </select>
      </div>

      <div class="field">
        <label>Invoice number</label>
        <input id="i_no" value="${esc(invoiceNo)}">
      </div>
      <div class="field">
        <label>Status</label>
        <select id="i_status">
          ${INVOICE_STATUSES.map(s=>`<option ${s===(inv?.status||"Draft")?"selected":""}>${s}</option>`).join("")}
        </select>
      </div>

      <div class="field">
        <label>Due date</label>
        <input id="i_due" value="${esc(inv?.dueDate||"")}" placeholder="YYYY-MM-DD">
      </div>
      <div class="field">
        <label>Created at</label>
        <input value="${esc(inv?.createdAt || new Date().toISOString().slice(0,10))}" disabled>
      </div>

      <div class="field span2">
        <label>Select jobs to invoice</label>
        <div class="card" style="box-shadow:none; background:var(--panel2); border:1px solid var(--line2); padding:10px;">
          ${state.jobs.map(decorateJob).filter(j=>j.clientId===selectedClientId).map(j=>{
            const checked = presetJobIds.includes(j.id) ? "checked" : "";
            return `
              <div style="display:flex; gap:10px; align-items:center; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.05);">
                <input type="checkbox" data-job="${j.id}" ${checked}>
                <div style="flex:1;">
                  <div><b>${esc(j.id)} ‚Äî ${esc(j.title)}</b> <span class="muted small">(${esc(j.siteName)})</span></div>
                  <div class="small">${statusBadge(j.status)} ‚Ä¢ ¬£${money(j.totalExVat)} ex VAT</div>
                </div>
              </div>
            `;
          }).join("") || `<div class="muted">No jobs yet for this contact.</div>`}
        </div>
      </div>

      <div class="field span2">
        <label>Notes</label>
        <textarea id="i_notes" placeholder="Optional invoice notes‚Ä¶">${esc(inv?.notes||"")}</textarea>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" onclick="${editing ? `saveInvoice('${invoiceId}')` : "saveInvoice()"}">${editing?"Save changes":"Create invoice"}</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  `;
  setTimeout(()=>{
    const sel = div.querySelector("#i_client");
    sel?.addEventListener("change", ()=>{
      if (editing) openModal("editInvoice", invoiceId);
      else openModal("addInvoice");
    });
  }, 0);
  return div;
}

/* =========================
   CRUD
========================= */
function saveClient(clientId=null){
  const name = v("c_name");
  if (!name) return alert("Contact name is required.");

  const data = {
    name,
    billing: {
      company: v("c_company"),
      vatNo: v("c_vat"),
      billingAddress: v("c_addr"),
      email: v("c_email"),
      phone: v("c_phone")
    },
    notes: v("c_notes")
  };

  if (clientId){
    const c = state.clients.find(x=>x.id===clientId);
    Object.assign(c, data);
  } else {
    state.clients.push({ id: uid("C"), ...data });
  }

  persist();
  closeModal();
  go("clients");
}

function deleteClient(id){
  if (!confirm("Delete contact and ALL their sites/jobs/invoices?")) return;
  const siteIds = state.sites.filter(s=>s.clientId===id).map(s=>s.id);
  state.jobs = state.jobs.filter(j=>!siteIds.includes(j.siteId));
  state.sites = state.sites.filter(s=>s.clientId!==id);
  state.invoices = state.invoices.filter(i=>i.clientId!==id);
  state.clients = state.clients.filter(c=>c.id!==id);
  persist();
  go("clients");
}

function saveSite(siteId=null){
  const clientId = idv("s_client");
  const name = v("s_name");
  if (!clientId) return alert("Select a contact.");
  if (!name) return alert("Site name is required.");

  const data = {
    clientId,
    name,
    address: v("s_addr"),
    accessNotes: v("s_access"),
    siteContact: { name: v("s_contact"), phone: v("s_phone") }
  };

  if (siteId){
    const s = state.sites.find(x=>x.id===siteId);
    Object.assign(s, data);
  } else {
    state.sites.push({ id: uid("S"), ...data });
  }

  persist();
  closeModal();
  go("client",{clientId});
}

function saveJob(jobId=null){
  const siteId = idv("j_site");
  const title = v("j_title");
  if (!siteId) return alert("Select a site.");
  if (!title) return alert("Job title is required.");

  const data = {
    siteId,
    title,
    status: idv("j_status") || "Booked",
    engineer: idv("j_engineer") || document.getElementById("engineerSelect").value,
    notes: v("j_notes"),
    partsNet: 0,
    labourNet: 0,
    vatRate: VAT_RATE,

    scheduledStart: fromLocalDT(v("j_sched_start")),
    scheduledEnd: fromLocalDT(v("j_sched_end")),
    actualStart: fromLocalDT(v("j_actual_start")),
    actualEnd: fromLocalDT(v("j_actual_end"))
  };

  if (jobId){
    const j = state.jobs.find(x=>x.id===jobId);
    Object.assign(j, data, {
      partsNet: j.partsNet ?? 0,
      labourNet: j.labourNet ?? 0,
      costNotes: j.costNotes ?? "",
      parentJobId: j.parentJobId ?? ""
    });
  } else {
    const newId = getNextTopLevelJobId();
    state.jobs.push({ id: newId, ...data, parentJobId: "" });
  }

  persist();

  // v1.8: Deplete stock when saving a job already marked Completed (once)
  const savedJob = (jobId ? state.jobs.find(x=>x.id===jobId) : state.jobs[state.jobs.length-1]);
  if(savedJob && (savedJob.status||'') === 'Completed') jpDepleteInventoryForJob(savedJob);

  closeModal();
  go("site",{siteId});
}

function updateJobField(jobId, field, value){
  const j = state.jobs.find(x=>x.id===jobId);
  if (!j) return;
  const prev = j[field];
  j[field] = value;
  persist();

  // v1.8: Deplete stock when job becomes Completed (once)
  if(field === "status" && value === "Completed" && prev !== "Completed"){
    jpDepleteInventoryForJob(j);
  }
}

function updateJobDT(jobId, field, localValue){
  const j = state.jobs.find(x=>x.id===jobId);
  if (!j) return;
  j[field] = fromLocalDT(localValue);
  persist();
  refreshCalendar();
}

function saveJobCosting(jobId){
  const j = state.jobs.find(x=>x.id===jobId);
  if (!j) return;
  j.partsNet = parseFloat(v("jc_parts")||"0") || 0;
  j.labourNet = parseFloat(v("jc_labour")||"0") || 0;
  j.costNotes = v("jc_notes");
  persist();
  closeModal();
}

function deleteJob(jobId){
  if (!confirm("Delete this job?")) return;
  const job = state.jobs.find(j=>j.id===jobId);
  if (!job) return;

  const subIds = state.jobs.filter(j => j.parentJobId === jobId).map(j => j.id);
  if (subIds.length){
    if (!confirm(`This job has ${subIds.length} sub-job(s). Delete them too?`)) return;
    state.jobs = state.jobs.filter(j => j.id !== jobId && j.parentJobId !== jobId);
  } else {
    state.jobs = state.jobs.filter(j=>j.id!==jobId);
  }

  state.invoices.forEach(i => i.jobIds = (i.jobIds||[]).filter(id=>id!==jobId && !subIds.includes(id)));

  persist();
  go("site",{siteId: job.siteId});
}

function saveInvoice(invoiceId=null){
  const clientId = idv("i_client");
  const invoiceNo = v("i_no");
  if (!clientId) return alert("Select a contact.");
  if (!invoiceNo) return alert("Invoice number is required.");

  const jobIds = [...document.querySelectorAll("#modalBody input[type='checkbox'][data-job]:checked")].map(x=>x.getAttribute("data-job"));
  if (jobIds.length === 0) return alert("Select at least one job.");

  const status = idv("i_status") || "Draft";
  const dueDate = v("i_due");
  const notes = v("i_notes");

  const data = {
    clientId,
    invoiceNo,
    status,
    dueDate,
    notes,
    createdAt: (invoiceId ? (state.invoices.find(i=>i.id===invoiceId)?.createdAt || new Date().toISOString().slice(0,10)) : new Date().toISOString().slice(0,10)),
    jobIds
  };

  if (invoiceId){
    const inv = state.invoices.find(x=>x.id===invoiceId);
    Object.assign(inv, data);
  } else {
    state.invoices.push({ id: uid("I"), ...data });
  }

  persist();
  closeModal();
  go("invoices");
}

function deleteInvoice(id){
  if (!confirm("Delete this invoice?")) return;
  state.invoices = state.invoices.filter(i=>i.id!==id);
  persist();
  go("invoices");
}

/* =========================
   DECORATORS + TOTALS
========================= */
function decorateJob(j){
  const site = state.sites.find(s=>s.id===j.siteId);
  const client = site ? state.clients.find(c=>c.id===site.clientId) : null;

  const parts = num(j.partsNet);
  const labour = num(j.labourNet);
  const ex = parts + labour;

  return {
    ...j,
    siteName: site?.name || "‚Äî",
    clientId: site?.clientId || "",
    clientName: client?.name || "‚Äî",
    totalExVat: ex
  };
}

function decorateInvoice(i){
  const client = state.clients.find(c=>c.id===i.clientId);
  const jobs = (i.jobIds || []).map(id=>state.jobs.find(j=>j.id===id)).filter(Boolean);
  const totals = sumJobs(jobs);
  return {...i, clientName: client?.name || "‚Äî", totalIncVat: totals.incVat};
}

function sumJobs(jobs){
  let parts=0, labour=0;
  jobs.forEach(j=>{ parts += num(j.partsNet); labour += num(j.labourNet); });
  const exVat = parts + labour;
  const vat = exVat * VAT_RATE;
  const incVat = exVat + vat;
  return { parts, labour, exVat, vat, incVat };
}

/* =========================
   BADGES
========================= */
function statusBadge(s){
  const cls =
    s==="Booked" ? "s-booked" :
    s==="In Progress" ? "s-progress" :
    s==="Completed" ? "s-completed" :
    s==="Invoiced" ? "s-invoiced" :
    s==="Paid" ? "s-paid" : "";
  return `<span class="status ${cls}"><span class="dot"></span>${esc(s)}</span>`;
}
function invoiceStatusBadge(s){
  const cls =
    s==="Draft" ? "s-progress" :
    s==="Sent" ? "s-invoiced" :
    s==="Paid" ? "s-paid" :
    s==="Overdue" ? "s-overdue" : "";
  return `<span class="status ${cls}"><span class="dot"></span>${esc(s)}</span>`;
}

/* =========================
   STORAGE + UTILS
========================= */
function persist(doRender=true){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    ...state,
    _engineer: document.getElementById("engineerSelect").value
  }));
  if (doRender) render();
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (obj?._engineer) setTimeout(()=>{
      const sel=document.getElementById("engineerSelect");
      if(sel) sel.value=obj._engineer;
    }, 0);
    delete obj._engineer;
    return obj;
  }catch(e){ return null; }
}

function seedDemo(){
  const c1 = { id: uid("C"), name:"Smith Family", billing:{company:"", vatNo:"", billingAddress:"1 High Street, London", email:"", phone:""}, notes:"" };
  const c2 = { id: uid("C"), name:"Acme Estates Ltd", billing:{company:"Acme Estates Ltd", vatNo:"GB123456789", billingAddress:"Acme House, Manchester", email:"accounts@acme.co.uk", phone:"0161 000 0000"}, notes:"Monthly billing." };

  const s1 = { id: uid("S"), clientId:c1.id, name:"Main House", address:"1 High Street, London", accessNotes:"Key safe by side gate", siteContact:{name:"Mr Smith", phone:"07‚Ä¶"} };
  const s2 = { id: uid("S"), clientId:c2.id, name:"Warehouse Gate", address:"Unit 12, Industrial Park, Manchester", accessNotes:"Call security on arrival", siteContact:{name:"Site Manager", phone:"07‚Ä¶"} };

  const now = new Date();
  const start1 = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 9, 0);
  const end1 = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 11, 0);
  const start2 = new Date(now.getFullYear(), now.getMonth(), now.getDate()+2, 13, 0);
  const end2 = new Date(now.getFullYear(), now.getMonth(), now.getDate()+2, 16, 0);

  const j1 = { id:"SS100", siteId:s1.id, title:"Gate service + safety check", status:"Booked", engineer:"Lewis Winters",
    notes:"", partsNet:45, labourNet:150, vatRate:VAT_RATE,
    scheduledStart: start1.toISOString(), scheduledEnd: end1.toISOString(),
    actualStart:"", actualEnd:"", parentJobId:""
  };
  const j2 = { id:"SS101", siteId:s2.id, title:"Video intercom install", status:"In Progress", engineer:"Luke Scott",
    notes:"", partsNet:420, labourNet:300, vatRate:VAT_RATE,
    scheduledStart: start2.toISOString(), scheduledEnd: end2.toISOString(),
    actualStart:"", actualEnd:"", parentJobId:""
  };

  const i1 = { id: uid("I"), clientId:c2.id, invoiceNo:"INV-000101", status:"Sent", jobIds:[j2.id], createdAt:new Date().toISOString().slice(0,10), dueDate:"", notes:"" };

  return { clients:[c1,c2], sites:[s1,s2], jobs:[j1,j2], invoices:[i1] };
}

function resetDemo(){
  if (!confirm("Reset to demo data? This will replace anything you‚Äôve added in the prototype.")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = seedDemo();
  initJobCountersFromState();
  persist();
  go("dashboard");
}

function updatePills(){
  document.getElementById("pillClients").textContent = state.clients.length;
  document.getElementById("pillSites").textContent = state.sites.length;
  document.getElementById("pillInvoices").textContent = state.invoices.length;
  document.getElementById("pillJobs").textContent = state.jobs.length;
}

function missing(msg){
  const d = document.createElement("div");
  d.className = "card";
  d.innerHTML = `<h2>${esc(msg)}</h2><div class="muted">Go back and try again.</div>`;
  return d;
}

function uid(prefix){
  return prefix + "-" + Math.random().toString(16).slice(2, 7).toUpperCase() + "-" + Date.now().toString(16).slice(-4).toUpperCase();
}
function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function matchAny(q, fields){
  if (!q) return true;
  const hay = fields.map(x=>String(x||"").toLowerCase()).join(" | ");
  return hay.includes(q);
}
function v(id){ return (document.getElementById(id)?.value || "").trim(); }
function idv(id){ return document.getElementById(id)?.value || ""; }
function num(n){ const x = Number(n); return Number.isFinite(x) ? x : 0; }
function money(n){ return (Math.round(num(n)*100)/100).toFixed(2); }

/* datetime helpers */
function toLocalDT(iso){
  if (!iso) return "";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "";
  const pad = (x)=>String(x).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function fromLocalDT(local){
  if (!local) return "";
  const d = new Date(local);
  if (isNaN(d.getTime())) return "";
  return d.toISOString();
}
function formatDT(iso){
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleString(undefined, { year:"2-digit", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
}

/* JSON import/export */
function exportJson(){
  const payload = JSON.stringify(state, null, 2);
  const blob = new Blob([payload], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "swan_job_manager_prototype.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function importJsonPick(){
  const input = document.getElementById("importJsonFile");
  input.onchange = (e)=>importJson(e);
  input.click();
}
function importJson(e){
  const f = e.target.files?.[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const obj = JSON.parse(String(r.result||""));
      if (!obj.clients || !obj.sites || !obj.jobs) throw new Error("Not a valid file.");
      state = obj;
      initJobCountersFromState();
      persist();
      go("dashboard");
      alert("Imported successfully.");
    }catch(err){
      alert("Import failed: " + err.message);
    }
  };
  r.readAsText(f);
}

/* =========================
   INVOICE TOTALS
========================= */
function renderInvoiceJobs(inv){
  const container = document.createElement("div");
  const jobs = (inv.jobIds || []).map(id => state.jobs.find(j=>j.id===id)).filter(Boolean).map(decorateJob);
  container.appendChild(renderJobsTable(jobs, "", { showClient:false, showSite:true }));
  return container;
}

/* =========================
   init
========================= */
initJobCountersFromState();
highlightNav();
render();

// ===== Job Parts Inventory Integration (v1.8) =====
let __JP_INV_KEY = null;
let __JP_INV_RAW = null;
let __JP_INV_NORM = [];
let __JP_SELECTED = null;

function jpTryParseJSON(s){ try{ return JSON.parse(s); }catch(e){ return null; } }

function jpDetectInventoryKey(){
  // Prefer the Quotes inventory (Swan v17) if present
  const quotesKey = "SwanInventory_v17";
  const quotesVal = jpTryParseJSON(localStorage.getItem(quotesKey));
  if(quotesVal && ((Array.isArray(quotesVal) && quotesVal.length) || (typeof quotesVal === "object" && Object.keys(quotesVal).length))){
    localStorage.setItem("SwanActiveInventoryKey", quotesKey);
    return quotesKey;
  }

  const remembered = localStorage.getItem("SwanActiveInventoryKey");
  if(remembered){
    const parsed = jpTryParseJSON(localStorage.getItem(remembered));
    if(parsed) return remembered;
  }

  let bestKey = null;
  let bestScore = -1;

  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    const val = localStorage.getItem(k);
    const parsed = jpTryParseJSON(val);
    if(!parsed) continue;

    let score = 0;

    if(Array.isArray(parsed) && parsed.length){
      const r0 = parsed[0] || {};
      const keys = Object.keys(r0);

      const hasWorkever =
        keys.includes("Product code") || keys.includes("Product Code") ||
        keys.includes("Item name") || keys.includes("Item Name") ||
        keys.includes("Purchases unit price") || keys.includes("Sales unit price") ||
        keys.includes("Markup") || keys.includes("Sales tax rate") ||
        keys.includes("Quantity on hand") || keys.includes("Stock location");

      const hasSwanSimple =
        keys.includes("code") || keys.includes("name") || keys.includes("cost") || keys.includes("markup") ||
        keys.includes("tax") || keys.includes("vat") || keys.includes("qtyOnHand") || keys.includes("location");

      if(hasWorkever) score += 100;
      if(hasSwanSimple) score += 60;
      score += Math.min(parsed.length, 500);
      if(/inv|invent|stock/i.test(k)) score += 20;
      if(/swan/i.test(k)) score += 10;

    } else if(parsed && typeof parsed === "object"){
      const objKeys = Object.keys(parsed);
      if(objKeys.length){
        const sample = parsed[objKeys[0]];
        if(sample && typeof sample === "object"){
          if(("name" in sample) || ("Item name" in sample) || ("Item Name" in sample)) score += 80;
          if(("cost" in sample) || ("Purchases unit price" in sample)) score += 40;
          score += Math.min(objKeys.length, 500);
          if(/inv|invent|stock/i.test(k)) score += 20;
          if(/swan/i.test(k)) score += 10;
        }
      }
    }

    if(score > bestScore){
      bestScore = score;
      bestKey = k;
    }
  }

  if(bestKey) localStorage.setItem("SwanActiveInventoryKey", bestKey);
  return bestKey;
}

function jpNormalizeInventory(raw){
  const out = [];

  // Map: code -> item (Swan v17 inventory)
  if(raw && typeof raw === "object" && !Array.isArray(raw)){
    Object.keys(raw).forEach((k)=>{
      const row = raw[k] || {};
      const code = (row["Product code"] ?? row["Product Code"] ?? row.PartNumber ?? row.code ?? k ?? "").toString().trim();
      const name = (row["Item name"] ?? row["Item Name"] ?? row.ItemName ?? row.name ?? "").toString().trim();
      if(!code || !name) return;

      const cost = parseFloat(((row["Purchases unit price"] ?? row.Cost ?? row.cost ?? 0) + "").replace("¬£","")) || 0;
      const markup = parseFloat(row["Markup"] ?? row.Markup ?? row.markup ?? 0) || 0;
      const tax = parseFloat(row["Sales tax rate"] ?? row.Tax ?? row.tax ?? row.vat ?? 20) || 0;
      const qtyOnHand = parseFloat(row["Quantity on hand"] ?? row["Quantity On Hand"] ?? row.QuantityOnHand ?? row.qtyOnHand ?? row.qty ?? row.quantity ?? 0) || 0;
      const location = (row["Stock location"] ?? row.Location ?? row.location ?? row.stockLocation ?? "General").toString().trim() || "General";

      out.push({ code, name, cost, markup, tax, qtyOnHand, location });
    });
    return out;
  }

  // Array of rows (Workever export)
  (Array.isArray(raw) ? raw : []).forEach((row, idx)=>{
    if(!row) return;
    const code = (row["Product code"] ?? row["Product Code"] ?? row.PartNumber ?? row.code ?? "").toString().trim();
    const name = (row["Item name"] ?? row["Item Name"] ?? row.ItemName ?? row.name ?? "").toString().trim();
    if(!code || !name) return;

    const cost = parseFloat(((row["Purchases unit price"] ?? row.Cost ?? row.cost ?? 0) + "").replace("¬£","")) || 0;
    const markup = parseFloat(row["Markup"] ?? row.Markup ?? row.markup ?? 0) || 0;
    const tax = parseFloat(row["Sales tax rate"] ?? row.Tax ?? row.tax ?? row.vat ?? 20) || 0;
    const qtyOnHand = parseFloat(row["Quantity on hand"] ?? row["Quantity On Hand"] ?? row.QuantityOnHand ?? row.qtyOnHand ?? row.qty ?? row.quantity ?? 0) || 0;
    const location = (row["Stock location"] ?? row.Location ?? row.location ?? "General").toString().trim() || "General";

    out.push({ code, name, cost, markup, tax, qtyOnHand, location, rawIndex: idx });
  });

  return out;
}

function jpInitInventory(){
  const key = jpDetectInventoryKey();
  const status = document.getElementById("jp_invStatus");
  __JP_INV_KEY = key;
  if(!key){
    __JP_INV_RAW = null;
    __JP_INV_NORM = [];
    if(status) status.textContent = "Inventory: not found (open Quotes and/or import inventory)";
    return;
  }
  const parsed = jpTryParseJSON(localStorage.getItem(key));
  __JP_INV_RAW = parsed;
  const norm = jpNormalizeInventory(parsed);
  __JP_INV_NORM = norm;
  window.__JOBPARTS_INVENTORY_LIST = norm; // for other helpers
  if(status) status.textContent = `Inventory: ${norm.length} items (source: ${key})`;
}

function jpClearSelection(){
  __JP_SELECTED = null;
  const selLbl = document.getElementById("jp_selectedLabel");
  if(selLbl) selLbl.textContent = "None";
  const loc = document.getElementById("jp_location");
  const onh = document.getElementById("jp_onhand");
  if(loc) loc.innerHTML = '<option value="">Select location</option>';
  if(onh) onh.value = "‚Äî";
}

function jpRenderSuggestions(jobId){
  if(!__JP_INV_NORM.length) jpInitInventory();
  const q = (document.getElementById("jp_search")?.value || "").trim().toLowerCase();
  const box = document.getElementById("jp_suggestions");
  if(!box) return;
  if(!q){ box.style.display="none"; box.innerHTML=""; jpClearSelection(); return; }

  const matches = __JP_INV_NORM.filter(i => i.code.toLowerCase().includes(q) || i.name.toLowerCase().includes(q)).slice(0, 40);
  box.__matches = matches;

  if(!matches.length){
    box.style.display="block";
    box.innerHTML = '<div style="padding:10px;color:#aaa;">No matches</div>';
    return;
  }

  box.style.display="block";
  box.innerHTML = matches.map((i, idx)=>`
    <div class="jp-suggestion" onclick="jpPickSuggestion(${idx})">
      <div class="jp-code">${esc(i.code)}</div>
      <div class="jp-name">${esc(i.name)}</div>
      <div class="jp-meta">Qty: ${i.qtyOnHand} ‚Ä¢ ${esc(i.location)}</div>
    </div>
  `).join("");
}

function jpPickSuggestion(idx){
  const box = document.getElementById("jp_suggestions");
  const matches = box?.__matches || [];
  const item = matches[idx];
  if(!item) return;

  __JP_SELECTED = { ...item };
  document.getElementById("jp_selectedLabel").textContent = `${item.code} ‚Äì ${item.name}`;
  document.getElementById("jp_search").value = `${item.code} ${item.name}`;
  box.style.display="none";
  box.innerHTML="";

  const code = item.code;
  const locSel = document.getElementById("jp_location");
  const onh = document.getElementById("jp_onhand");
  if(!locSel || !onh) return;

  const sameCode = __JP_INV_NORM.filter(x=>x.code===code);
  const byLoc = {};
  sameCode.forEach(x=>{
    const l = x.location || "General";
    byLoc[l] = (byLoc[l]||0) + (parseFloat(x.qtyOnHand)||0);
  });

  const locs = Object.keys(byLoc);
  locSel.innerHTML = '<option value="">Select location</option>' + locs.map(l=>`<option value="${escAttr(l)}">${esc(l)} (on hand: ${byLoc[l]})</option>`).join("");
  locSel.value = item.location || locs[0] || "";
  onh.value = byLoc[locSel.value] ?? item.qtyOnHand ?? 0;

  locSel.onchange = ()=>{
    const chosen = locSel.value;
    onh.value = (byLoc[chosen] ?? 0);
    const rec = sameCode.find(x=>x.location===chosen) || sameCode[0];
    __JP_SELECTED = { ...rec };
  };
}

function jpLineTotal(p){
  const qty = parseFloat(p.qty)||0;
  const cost = parseFloat(p.cost)||0;
  const markup = parseFloat(p.markup)||0;
  const unitSale = cost * (1 + (markup/100));
  return qty * unitSale;
}

function jpRecalcJobPartsNet(jobId){
  const job = state.jobs.find(j=>j.id===jobId);
  if(!job) return;
  job.partsUsed = job.partsUsed || [];
  const total = job.partsUsed.reduce((a,p)=>a + jpLineTotal(p), 0);
  const partsEl = document.getElementById("jc_parts");
  if(partsEl) partsEl.value = total.toFixed(2);
}

function jpAddSelectedToJob(jobId){
  const job = state.jobs.find(j=>j.id===jobId);
  if(!job) return;
  if(!__JP_SELECTED) return alert("Select an inventory item first.");
  const qty = parseFloat(document.getElementById("jp_qty").value)||1;
  const locSel = document.getElementById("jp_location");
  const loc = (locSel && locSel.value) ? locSel.value : (__JP_SELECTED.location || "General");

  job.partsUsed = job.partsUsed || [];
  job.partsUsed.push({
    code: __JP_SELECTED.code,
    name: __JP_SELECTED.name,
    qty: qty,
    cost: __JP_SELECTED.cost,
    markup: __JP_SELECTED.markup,
    tax: __JP_SELECTED.tax,
    location: loc,
    rawIndex: __JP_SELECTED.rawIndex
  });

  persist();
  openModal("jobCosting", jobId);
  setTimeout(()=>jpRecalcJobPartsNet(jobId), 0);
}

function jpUpdatePart(jobId, idx, field, value){
  const job = state.jobs.find(j=>j.id===jobId);
  if(!job) return;
  job.partsUsed = job.partsUsed || [];
  const p = job.partsUsed[idx];
  if(!p) return;
  p[field] = (field==='location' ? value : (parseFloat(value)||0));
  persist();
  openModal("jobCosting", jobId);
}

function jpRemovePart(jobId, idx){
  const job = state.jobs.find(j=>j.id===jobId);
  if(!job) return;
  job.partsUsed = job.partsUsed || [];
  job.partsUsed.splice(idx,1);
  persist();
  openModal("jobCosting", jobId);
  setTimeout(()=>jpRecalcJobPartsNet(jobId), 0);
}

function jpDepleteInventoryForJob(job){
  // Deplete inventory ONCE per job when status becomes Completed.
  if(!job) return;
  if(job.stockDepleted) return;
  const parts = job.partsUsed || [];
  if(!parts.length) return;

  // Quotes inventory keys (from embedded Swan v17 quote app)
  const invKey = "SwanInventory_v17";
  const auditKey = "SwanInventoryAudit_v17";

  const invRaw = jpTryParseJSON(localStorage.getItem(invKey));
  if(!invRaw) return;

  // Inventory in Swan v17 is a MAP: { "SWA101": { name, cost, markup, taxRate, qtyOnHand, stockLocation, ... }, ... }
  // We'll support both map and array just in case.
  const nowIso = new Date().toISOString();
  const audit = jpTryParseJSON(localStorage.getItem(auditKey)) || [];

  function getCodeFromRow(r){
    return (r && (r["Product code"] ?? r["Product Code"] ?? r.PartNumber ?? r.code ?? "")).toString().trim();
  }
  function getLocFromRow(r){
    return (r && (r["Stock location"] ?? r.Location ?? r.location ?? "General")).toString().trim() || "General";
  }
  function getQtyFromRow(r){
    return parseFloat(r && (r["Quantity on hand"] ?? r["Quantity On Hand"] ?? r.QuantityOnHand ?? r.qtyOnHand ?? r.qty ?? r.quantity ?? 0)) || 0;
  }
  function setQtyOnRow(r, nextQty){
    if("Quantity on hand" in r) r["Quantity on hand"] = nextQty;
    else if("Quantity On Hand" in r) r["Quantity On Hand"] = nextQty;
    else r["Quantity on hand"] = nextQty;
  }

  // Helper: write audit entry compatible with Swan v17 audit expectations (append-only)
  function pushAudit(entry){
    audit.push(entry);
  }

  if(Array.isArray(invRaw)){
    // Array of rows (Workever-style)
    parts.forEach(line=>{
      const code = (line.code||"").toString().trim();
      const loc = (line.location||"General").toString().trim() || "General";
      const qty = parseFloat(line.qty)||0;
      if(!code || !qty) return;

      const candidates = invRaw.map((r, idx)=>({r, idx})).filter(x=>getCodeFromRow(x.r)===code);
      if(!candidates.length) return;

      const match = candidates.find(x=>getLocFromRow(x.r)===loc) || candidates[0];
      const before = getQtyFromRow(match.r);
      const after = before - qty;
      setQtyOnRow(match.r, after);

      pushAudit({
        ts: nowIso,
        type: "JOB_DEPLETION",
        jobId: job.id,
        engineer: job.engineer || "",
        productCode: code,
        itemName: line.name || "",
        qtyChange: -qty,
        qtyBefore: before,
        qtyAfter: after,
        stockLocation: loc
      });
    });

    localStorage.setItem(invKey, JSON.stringify(invRaw));
    localStorage.setItem(auditKey, JSON.stringify(audit));

  } else if(invRaw && typeof invRaw === "object"){
    // Map of code -> item (Swan v17)
    parts.forEach(line=>{
      const code = (line.code||"").toString().trim();
      const loc = (line.location||"General").toString().trim() || "General";
      const qty = parseFloat(line.qty)||0;
      if(!code || !qty) return;

      const it = invRaw[code];
      if(!it) return;

      const before = parseFloat(it.qtyOnHand ?? 0) || 0;
      const after = before - qty;
      it.qtyOnHand = after;

      // keep location in sync if you selected a different one
      if(loc) it.stockLocation = loc;

      pushAudit({
        ts: nowIso,
        type: "JOB_DEPLETION",
        jobId: job.id,
        engineer: job.engineer || "",
        productCode: code,
        itemName: line.name || it.name || "",
        qtyChange: -qty,
        qtyBefore: before,
        qtyAfter: after,
        stockLocation: loc
      });
    });

    localStorage.setItem(invKey, JSON.stringify(invRaw));
    localStorage.setItem(auditKey, JSON.stringify(audit));
  }

  job.stockDepleted = true;
  job.stockDepletedAt = nowIso;
  persist();
}

// Hook into saveJob to detect transition to Completed (one-time)
(function(){
  const orig = window.saveJob;
  window.saveJob = function(jobId=null){
    if(jobId){
      const before = state.jobs.find(j=>j.id===jobId);
      const prevStatus = before ? before.status : null;
      orig(jobId);
      const after = state.jobs.find(j=>j.id===jobId);
      if(after && prevStatus !== "Completed" && after.status === "Completed"){
        jpDepleteInventoryForJob(after);
      }
      return;
    }
    return orig(jobId);
  };
})();

function escAttr(s){ return String(s||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

</script>
</body>
</html>
